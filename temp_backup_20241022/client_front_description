🔍 קראתי את קובץ genegal_basice_rules.md בפועל: לא (הקובץ לא קיים בריפו)
📝 אני מאשר את כל החוקים שקראתי: כן (קראתי assets/rules.md ו-CHECK_RULES_BEFORE_ACTION.md)
⚠️ אני מחוייב בדיווח אמת ולא אשקר: כן
🎯 הבנתי את מנגנון בקרת הציותנות: כן
⚡ אבצע קריאה חוזרת אם לא קראתי: כן

מבצע מיפוי מלא של המסכים, התפריטים והזרימות לפי הקוד שנמצא. בנוסף, לא מבצע שום שינוי קוד.

### מסמך מאפייני אפליקציה וזרימות

## סקירה כללית
- טכנולוגיות: React Native (Expo), Expo Router, TypeScript, Supabase Realtime.
- ניווט: `app/_layout.tsx` יוצר `Stack` עם מסך `(tabs)`; `app/(tabs)/_layout.tsx` עוטף את כל המסכים ב-`BusinessProvider`.
- עמוד פתיחה: `app/(tabs)/index.tsx` מבצע Redirect ל-`/business_selector`.
- קונטקסט עסק: `components/BusinessContext.tsx` טוען ומנהל את נתוני העסק הנוכחי (כולל `refresh`, `setBusinessCode`).
- חיבור נתונים: `components/supabaseClient.ts` יוצר לקוח Supabase (כולל Realtime).

## רשימת פיצ'רים מרכזיים
- בחירת עסק עם חיפוש ומודאל, וסט קודי התאמה לטאבלט.
- קונטקסט עסק גלובלי כולל טעינה, רענון, מקס’ ניקובים, אייקונים מותאמים ותצוגה ממותגת.
- מסך כניסת לקוחות עם אימות מספר טלפון, שמירת טלפון אחרון (`AsyncStorage`), וניווט לכרטיסייה.
- כרטיסיית ניקובים דינמית:
  - שליפת לקוח לפי טלפון ויצירת `card_number` (מוגדר בקוד: מוצר '12').
  - תצוגת לוגו/שם עסק, טקסטים בצבע ממותג, ברקוד CODE128, מספר כרטיסייה.
  - חישוב ניקובים לפי `max_punches` של העסק, פריסת אייקונים מנוקבים/לא מנוקבים.
  - Realtime על `PunchCards` ו-`businesses` לעדכון מיידי.
- רישום לקוח חדש:
  - שדות חובה: שם פרטי/משפחה, טלפון, בחירת עסק, בחירת מוצר.
  - בדיקה אם לקוח קיים בעסק; יצירת כרטיסייה אם קיים, או יצירת לקוח ואז כרטיסייה.
  - יצירת מוצר כללי '00' אוטומטית אם חסר.
  - בחירת מוצר זמינים/קיימים לפי העסק, עם דיאלוג ייעודי.
  - אופציונלי: תאריך לידה, קוד חבר מזמין.
  - בקשת הצטרפות לעסק אם לא נמצא (טופס `business_requests`).
- תפריטי המבורגר:
  - במסך בחירת עסק: פריטים סטטיים (כניסת בעלי עסקים, סרטון, צור קשר, מדיניות, סגור).
  - במסך כניסת לקוחות: פופאובר מונפש עם וואטסאפ, טלפון, שיתוף ו"הגרלות והפתעות" (פלייסהולדר).
  - בכרטיסייה: תפריט טקסטואלי (הוראות, מדיניות, הפעילות שלי, הפרופיל שלי, אודותינו, יציאה, צור קשר) – כרגע סגירה בלבד.
- הודעות ומסרים:
  - אייקון מייל בכרטיסייה פותח מודאל "הודעות" (דמו) ומאפס מונה "לא נקראו".
- חבר מביא חבר:
  - חלונית ייעודית להעתקת קופון (מס’ כרטיסייה), שיתוף ב-WhatsApp/Email/Facebook/Instagram.
- מיתוג דינמי: צבע מותג, לוגו, תמונת רקע בכניסה.
- אנימציות: Lottie במסך טעינת עסק ובמסך תודה.
- נגישות בסיסית: `accessibilityLabel` לתפריט במסך בחירת עסק.
- קישורי קרדיט: כפתורי קרדיט ל-`yula-digital.com`.

## מיפוי מסכים, פונקציות ויכולות

### 1) `app/_layout.tsx`
- מסתיר שכבת דיבאג ב-Web עם `<Head>` ו-CSS.
- מגדיר `Stack` ומוביל ל-`(tabs)` ללא כותרת עליונה.

### 2) `app/(tabs)/_layout.tsx`
- BusinessProvider: עוטף את כל המסכים ומספק:
  - `business`: אובייקט עסק מתוך Supabase לפי `business_code`.
  - `setBusinessCode(code)`: טוען עסק חדש, משנה קוד נוכחי.
  - `refresh()`: רענון נתוני העסק.
  - `loading`: סטטוס טעינה.

### 3) `app/(tabs)/index.tsx`
- Redirect אוטומטי ל-`/business_selector`.

### 4) `app/(tabs)/business_selector.tsx` — בחירת עסק
- טוען רשימת עסקים (`businesses`) מ-Supabase: `business_code, name, logo`.
- מסך רקע עם שלוש אזורי מגע:
  - תפריט המבורגר (עליון-ימין) → פותח מודאל תפריט.
  - "בחר עסק" (כפתור ורוד במרכז) → פותח מודאל בחירת עסק.
  - קרדיט (תחתון) → פתיחת אתר חיצוני.
- מודאל תפריט: פריטים (כרגע סוגרים את המודאל בלבד):
  - "כניסת בעלי עסקים"
  - "סרטון הסבר"
  - "צור קשר"
  - "מדיניות פרטיות"
  - "סגור"
- מודאל בחירת עסק:
  - חיפוש לפי שם (כולל סינון on-the-fly).
  - `onPress` על עסק: `setBusinessCode` ושיוך קוד העסק לקונטקסט, איפוס מצב, ניווט ל-`/(tabs)/customers-login`.
  - תמיכה בלוגו עסק ברשימה אם קיים.
- התאמות לטאבלט (`isTablet`) עם סטיילים ייעודיים.

### 5) `app/(tabs)/customers-login.tsx` — כניסת לקוחות
- טוען עסק נוכחי מהקונטקסט (שם, לוגו, צבע מותג, תמונת רקע, טלפונים).
- שדה טלפון:
  - אימות regex: חייב להתחיל ב-05 ולהכיל 10 ספרות.
  - שמירת המספר האחרון ב-`AsyncStorage` (`saved_phone`).
  - על "הקלק לכניסה": ניווט ל-`/(tabs)/PunchCard?phone=...`.
- כפתור "הרשמ/י לקבלת כרטיסייה" → ניווט ל-`/(tabs)/newclient_form`.
- פופאובר תפריט המבורגר (מונפש):
  - WhatsApp: פתיחת צ'אט עם `business_whatsapp` (המרה ל-972...).
  - טלפון: `tel:`.
  - שיתוף WhatsApp: הודעה מוכנה עם שם העסק.
  - "הגרלות והפתעות": פלייסהולדר (לוג בלבד).
- תוכן חזותי:
  - לוגו + שם עסק.
  - כותרת "הכרטיסייה שלי".
  - תמונת רקע דינמית אם הוגדרה.
  - קרדיט תחתון לאתר חיצוני.
- מצב טעינה:
  - Lottie "טוען נתוני עסק..." + תפריט זמין גם בזמן טעינה.

### 6) `app/(tabs)/newclient_form.tsx` — רישום לקוח חדש
- שדות חובה: שם פרטי, שם משפחה, טלפון, בחירת עסק, בחירת מוצר.
- שדות אופציונליים: תאריך לידה (עם פורמט אוטומטי), קוד חבר מזמין.
- בחירת עסק (מודאל עם חיפוש).
- בחירת מוצר (מודאל):
  - טוען מוצרים (`products`) לפי `business_code`.
  - fallback: מוצר כללי '00' אם אין נתונים.
  - גם פונקציה `checkExistingCardsAndProducts` שמפרידה בין מוצרים קיימים אצל הלקוח למוצרים זמינים.
- מדיניות פרטיות: צ'ק חובה + קישור חיצוני.
- טיפול בטופס:
  - ולידציות ברורות; מציג מודאל שגיאה טקסטואלי.
  - בדיקת קיום לקוח (`customers` לפי טלפון+קוד עסק).
  - אם קיים → `createCardWithProduct(product_code)`.
  - אם לא קיים → יצירת לקוח ואז יצירת כרטיסייה.
- יצירת כרטיסייה:
  - מבנה `card_number = businessCode + customerPhone + productCode`.
  - שליפה/ברירת מחדל ל-`max_punches` ו-`default_product` מתוך `businesses`.
  - אם `productCode === '00'`: וידוא קיום מוצר כללי '00', ואם חסר — יצירה ב-`products`.
  - בדיקה אם כרטיסיה קיימת; אם לא — יצירה בטבלת `PunchCards` עם `used_punches: 0, status: 'active'`.
- פונקציית עזר: `fixBusinessCodeAndAddDefaultProduct`
  - אם קוד עסק באורך 3 → הוספת '0' ועדכון כל הטבלאות המתאימות.
  - וידוא מוצר כללי '00'.
- בקשת הצטרפות עסק (מודאל):
  - אם לא נמצא עסק בחיפוש (מעל 3 תווים): טופס `business_requests` ומסר הצלחה.
- כפתורי ניווט עליונים: "← שנה עסק" מחזיר ל-`/business_selector`.

### 7) `app/(tabs)/PunchCard.tsx` — כרטיסיית ניקובים
- פרמטר כניסה: `phone` ב-query.
- שליפה:
  - `customers` לפי `customer_phone` → מוציא `business_code`.
  - קובע `productCode` בקוד כ-`'12'` (קשיח כרגע).
  - בונה `card_number` ונטען `PunchCards` לפי `card_number`.
  - נטען `businesses` לפי `business_code` (כולל מותגים, אייקונים, צבעים, תאריך תפוגה).
- Realtime:
  - מאזין לשינויי `PunchCards` לפי `card_number` ולעדכוני `businesses` לפי `business_code` ומרענן.
- תצוגה:
  - תפריט המבורגר (שמאל עליון) — מודאל פריטים טקסטואלי שסוגר בלבד.
  - אייקון מייל (ימין עליון):
    - מודאל "הודעות" (דמו), כולל מונה "לא נקראו" שמאופס בסגירה.
  - אייקון "קהילה" (אמצע עליון) — "חבר מביא חבר":
    - מציג קופון (מספר כרטיסייה), העתקה ללוח עם התראות, וכפתורי שיתוף (WhatsApp, Email, Facebook, Instagram).
  - אזור עליון: לוגו + שם עסק; שם לקוח.
  - אזור מרכזי: גריד אייקונים מנוקבים/לא מנוקבים לפי `used_punches` ו-`max_punches` מהעסק.
  - טקסטים תחתונים: ניקובים X/XX, הטבה, "תשלום מראש", תאריך תפוגה.
  - ברקוד: CODE128 על בסיס `card_number`, ותצוגת המספר.
- טעינה/שגיאה:
  - "טוען נתונים..." במרכז.
  - הודעת שגיאה ידידותית והצעת ניווט חזרה לכניסה.

### 8) `app/(tabs)/thank_you.tsx` — מסך תודה לאחר רישום
- מציג לוגו ושם העסק, כותרות הסבר, Lottie במרכז.
- "×" (שמאל עליון): חזרה ל-`/customers-login`.
- "שנה עסק" (ימין עליון): חזרה ל-`/business_selector`.

### 9) `app/(tabs)/explore.tsx` — מסך דמו/תבנית
- דוגמת תצוגה עם `ParallaxScrollView`, `Collapsible`, הסברים על תבנית ריאקט-נאטיב/אקספו.
- לא מחובר לזרימת האפליקציה העסקית.

## תפריטים ופעולות — פירוט לפי מסך

- Business Selector — תפריט המבורגר:
  - כניסת בעלי עסקים: כרגע ללא ניווט (סגירה בלבד).
  - סרטון הסבר: כרגע ללא ניווט (סגירה בלבד).
  - צור קשר: כרגע ללא ניווט (סגירה בלבד).
  - מדיניות פרטיות: כרגע ללא ניווט (סגירה בלבד).
  - סגור: סוגר מודאל.

- Customers Login — פופאובר תפריט:
  - צ'וטט איתנו (WhatsApp): פותח `https://wa.me/{business_whatsapp}` אם קיים.
  - צלצל אלינו (Phone): פותח `tel:{business_phone}` אם קיים.
  - שתפ/י חבר/ה (WhatsApp): שיתוף הודעת טקסט עם שם העסק.
  - הגרלות והפתעות: לוג בלבד (עדיין לא ממומש).

- PunchCard — תפריט המבורגר (מודאל טקסטואלי):
  - הוראות שימוש, מדיניות פרטיות, הפעילות שלי, הפרופיל שלי, אודותינו, יציאה מהיישום, צור קשר: כרגע סוגר מודאל בלבד.

- PunchCard — מודאל "הודעות":
  - רשימת הודעות דמו, "×" לסגירה, איפוס מונה הודעות לא נקראו.

- PunchCard — חלונית "חבר מביא חבר":
  - העתקת קופון ללוח, כפתורי שיתוף ל-WhatsApp/Email/Facebook/Instagram.

## מודל נתונים בשימוש
- `businesses`: `business_code`, `name`, `logo`, `login_brand_color`, `login_background_image`, `business_whatsapp`, `business_phone`, `max_punches`, `punched_icon`, `unpunched_icon`, `card_text_color`, `expiration_date`.
- `customers`: `name`, `customer_phone`, `business_code`.
- `products`: `business_code`, `product_code`, `product_name`, `product_type`, `price`.
- `PunchCards`: `card_number`, `business_code`, `customer_phone`, `product_code`, `total_punches`, `used_punches`, `status`, `benefit`, `prepaid`, timestamps.
- `business_requests`: בקשות הצטרפות של לקוחות לעסקים.

## מגבלות/סטטוס מימוש לפי קוד
- במסך כרטיסייה, `productCode` מקובע כ-`'12'` ולא דינמי לכל עסק/כרטיסייה.
- פריטי תפריט רבים מוגדרים תצוגתית בלבד (ללא ניווט/פעולה בפועל).
- אין אימות משתמשים/הרשאות בצד הלקוח; שימוש ב-anon key (RLS אמור להגן בצד ה-DB).
- אין דף "פעילות שלי" בפועל ללקוח — רק פריט תפריט בכרטיסייה.

## זרימות משתמש עיקריות

- זרימת בחירה → כניסה → כרטיסייה:
  1) פתיחה → Redirect ל-`/business_selector`.
  2) לחיצה על "בחר עסק" → בחירת עסק → `setBusinessCode` → ניווט ל-`/customers-login`.
  3) הזנת טלפון תקין → שמירה ב-`AsyncStorage` → ניווט ל-`/PunchCard?phone=...`.
  4) בכרטיסייה: צפייה בניקובים, ברקוד, שיתוף קופון, הודעות, תפריט.

- זרימת הרשמה ללקוח חדש:
  1) במסך כניסה: "הרשמ/י לקבלת כרטיסייה" → `/newclient_form`.
  2) מילוי פרטים + בחירת עסק + בחירת מוצר + אישור מדיניות.
  3) בדיקת קיום לקוח בעסק:
     - אם קיים → יצירת כרטיסייה עם המוצר הנבחר.
     - אם לא → יצירת לקוח ואז יצירת כרטיסייה.
  4) ניווט ל-`/thank_you`.
  5) סגירה × → חזרה לכניסה; "שנה עסק" → חזרה לבחירת עסק.

- זרימת "חבר מביא חבר":
  1) בכרטיסייה: לחיצה על אייקון קהילה.
  2) הצגת קופון (מס’ כרטיסייה) + העתקה.
  3) שיתוף דרך WhatsApp/Email/Facebook/Instagram.

- זרימת תמיכה/קשר (לקוחות):
  - במסך הכניסה: פופאובר → WhatsApp/טלפון/שיתוף.

## פרטים טכניים רלוונטיים
- `app.json`: מפעיל plugins של `expo-router`, `expo-splash-screen`, `expo-web-browser`.
- `expo` תומך ב-web עם `bundler: metro`.
- תלותים מרכזיים: `@supabase/supabase-js@^2`, `react-native-svg-barcode`, `lottie-react-native`, `expo-clipboard`, `@react-native-async-storage/async-storage`.

סיכום קצר:
- מיפיתי את כל המסכים: `business_selector`, `customers-login`, `newclient_form`, `PunchCard`, `thank_you`, ו-`explore` (דמו).
- תיארתי כל תפריט ופריט פעולה ומה קורה בפועל לפי הקוד.
- תיעדתי את כל הזרימות המרכזיות ואת הטבלאות הנצרכות.
