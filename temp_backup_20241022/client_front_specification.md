# מסמך מאפייני אפליקציה וזרימות - גרסה מעודכנת

## סקירה כללית
- טכנולוגיות: React Native (Expo), Expo Router, TypeScript, Supabase Realtime.
- ניווט: `app/_layout.tsx` יוצר `Stack` עם מסך `(tabs)`; `app/(tabs)/_layout.tsx` עוטף את כל המסכים ב-`BusinessProvider`.
- עמוד פתיחה: `app/(tabs)/index.tsx` מבצע Redirect ל-`/business_selector`.
- קונטקסט עסק: `components/BusinessContext.tsx` טוען ומנהל את נתוני העסק הנוכחי (כולל `refresh`, `setBusinessCode`).
- חיבור נתונים: `components/supabaseClient.ts` יוצר לקוח Supabase (כולל Realtime).

## רשימת פיצ'רים מרכזיים
- בחירת עסק עם חיפוש ומודאל, וסט קודי התאמה לטאבלט.
- קונטקסט עסק גלובלי כולל טעינה, רענון, מקס' ניקובים, אייקונים מותאמים ותצוגה ממותגת.
- מסך כניסת לקוחות עם אימות מספר טלפון, שמירת טלפון אחרון (`AsyncStorage`), וניווט לכרטיסייה.
- כרטיסיית ניקובים דינמית:
  - שליפת לקוח לפי טלפון ויצירת `card_number` (מוגדר בקוד: מוצר '12').
  - תצוגת לוגו/שם עסק, טקסטים בצבע ממותג, ברקוד CODE128, מספר כרטיסייה.
  - חישוב ניקובים לפי `max_punches` של העסק, פריסת אייקונים מנוקבים/לא מנוקבים.
  - Realtime על `PunchCards` ו-`businesses` לעדכון מיידי.
- רישום לקוח חדש:
  - שדות חובה: שם פרטי/משפחה, טלפון, בחירת עסק, בחירת מוצר.
  - בדיקה אם לקוח קיים בעסק; יצירת כרטיסייה אם קיים, או יצירת לקוח ואז כרטיסייה.
  - יצירת מוצר כללי '00' אוטומטית אם חסר.
  - בחירת מוצר זמינים/קיימים לפי העסק, עם דיאלוג ייעודי.
  - אופציונלי: תאריך לידה, קוד חבר מזמין.
  - בקשת הצטרפות לעסק אם לא נמצא (טופס `business_requests`).
- תפריטי המבורגר:
  - במסך בחירת עסק: פריטים סטטיים (כניסת בעלי עסקים, סרטון, צור קשר, מדיניות, סגור).
  - במסך כניסת לקוחות: פופאובר מונפש עם וואטסאפ, טלפון, שיתוף ו"הגרלות והפתעות" (פלייסהולדר).
  - בכרטיסייה: תפריט טקסטואלי (הוראות, מדיניות, הפעילות שלי, הפרופיל שלי, אודותינו, יציאה, צור קשר) – כרגע סגירה בלבד.
- הודעות ומסרים:
  - אייקון מייל בכרטיסייה פותח מודאל "הודעות" (דמו) ומאפס מונה "לא נקראו".

## **מערכת חבר מביא חבר - מעודכן 2024**

### **יצירת קוד הזמנה מספרי:**
```javascript
const generateReferralCode = (businessCode: string, customerPhone: string): string => {
  const businessNumber = businessCode.padStart(4, '0').slice(-4);    // 4 ספרות עסק
  const phoneLast4 = customerPhone.slice(-4);                        // 4 ספרות אחרונות טלפון
  const randomDigits = Math.floor(1000 + Math.random() * 9000).toString(); // 4 ספרות רנדום
  return businessNumber + phoneLast4 + randomDigits;                 // סה"כ 12 ספרות
}
```

### **תכונות המערכת:**
- **קוד הזמנה ייחודי:** 12 ספרות מספריות (מתאים לברקוד)
- **שיתוף מתקדם:** WhatsApp, Email, Facebook, Instagram עם הודעות מותאמות
- **שליחה אוטומטית לSupabase:** כל הרשמה עם קוד הזמנה נשלחת לטבלת `referrals`
- **הצגת שוברים:** דרך תיבת דואר נכנס בכרטיסייה (הודעות פוש נשמרות)
- **מעקב מלא:** המערכת מזהה מזמין ומוזמן ויוצרת שוברים אוטומטית

### **זרימת חבר מביא חבר:**
1. לקוח ותיק יוצר קוד הזמנה (12 ספרות)
2. שיתוף הקוד דרך רשתות חברתיות או העתקה ידנית
3. חבר חדש נרשם עם הקוד - Frontend שולח לטבלת `referrals`
4. Supabase יוצר אוטומטית 2 שוברים (למזמין ולמוזמן)
5. שוברים מגיעים כהודעות פוש ונשמרים בתיבת דואר
6. לחיצה על הודעה בתיבה מציגה את השובר המלא

- מיתוג דינמי: צבע מותג, לוגו, תמונת רקע בכניסה.
- אנימציות: Lottie במסך טעינת עסק ובמסך תודה.
- נגישות בסיסית: `accessibilityLabel` לתפריט במסך בחירת עסק.
- קישורי קרדיט: כפתורי קרדיט ל-`yula-digital.com`.

## מיפוי מסכים, פונקציות ויכולות

### 1) `app/_layout.tsx`
- מסתיר שכבת דיבאג ב-Web עם `<Head>` ו-CSS.
- מגדיר `Stack` ומוביל ל-`(tabs)` ללא כותרת עליונה.

### 2) `app/(tabs)/_layout.tsx`
- BusinessProvider: עוטף את כל המסכים ומספק:
  - `business`: אובייקט עסק מתוך Supabase לפי `business_code`.
  - `setBusinessCode(code)`: טוען עסק חדש, משנה קוד נוכחי.
  - `refresh()`: רענון נתוני העסק.
  - `loading`: סטטוס טעינה.

### 3) `app/(tabs)/index.tsx`
- Redirect אוטומטי ל-`/business_selector`.

### 4) `app/(tabs)/business_selector.tsx` — בחירת עסק
- טוען רשימת עסקים (`businesses`) מ-Supabase: `business_code, name, logo`.
- מסך רקע עם שלוש אזורי מגע:
  - תפריט המבורגר (עליון-ימין) → פותח מודאל תפריט.
  - "בחר עסק" (כפתור ורוד במרכז) → פותח מודאל בחירת עסק.
  - קרדיט (תחתון) → פתיחת אתר חיצוני.
- מודאל תפריט: פריטים (כרגע סוגרים את המודאל בלבד):
  - "כניסת בעלי עסקים"
  - "סרטון הסבר"
  - "צור קשר"
  - "מדיניות פרטיות"
  - "סגור"
- מודאל בחירת עסק:
  - חיפוש לפי שם (כולל סינון on-the-fly).
  - `onPress` על עסק: `setBusinessCode` ושיוך קוד העסק לקונטקסט, איפוס מצב, ניווט ל-`/(tabs)/customers-login`.
  - תמיכה בלוגו עסק ברשימה אם קיים.
- התאמות לטאבלט (`isTablet`) עם סטיילים ייעודיים.

### 5) `app/(tabs)/customers-login.tsx` — כניסת לקוחות
- טוען עסק נוכחי מהקונטקסט (שם, לוגו, צבע מותג, תמונת רקע, טלפונים).
- שדה טלפון:
  - אימות regex: חייב להתחיל ב-05 ולהכיל 10 ספרות.
  - שמירת המספר האחרון ב-`AsyncStorage` (`saved_phone`).
  - על "הקלק לכניסה": ניווט ל-`/(tabs)/PunchCard?phone=...`.
- כפתור "הרשמ/י לקבלת כרטיסייה" → ניווט ל-`/(tabs)/newclient_form`.
- פופאובר תפריט המבורגר (מונפש):
  - WhatsApp: פתיחת צ'אט עם `business_whatsapp` (המרה ל-972...).
  - טלפון: `tel:`.
  - שיתוף WhatsApp: הודעה מוכנה עם שם העסק.
  - "הגרלות והפתעות": פלייסהולדר (לוג בלבד).
- תוכן חזותי:
  - לוגו + שם עסק.
  - כותרת "הכרטיסייה שלי".
  - תמונת רקע דינמית אם הוגדרה.
  - קרדיט תחתון לאתר חיצוני.
- מצב טעינה:
  - Lottie "טוען נתוני עסק..." + תפריט זמין גם בזמן טעינה.

### 6) `app/(tabs)/newclient_form.tsx` — רישום לקוח חדש (מעודכן)
- שדות חובה: שם פרטי, שם משפחה, טלפון, בחירת עסק, בחירת מוצר.
- שדות אופציונליים: תאריך לידה (עם פורמט אוטומטי), **קוד חבר מזמין (מעודכן)**.
- בחירת עסק (מודאל עם חיפוש).
- בחירת מוצר (מודאל):
  - טוען מוצרים (`products`) לפי `business_code`.
  - fallback: מוצר כללי '00' אם אין נתונים.
  - גם פונקציה `checkExistingCardsAndProducts` שמפרידה בין מוצרים קיימים אצל הלקוח למוצרים זמינים.
- מדיניות פרטיות: צ'ק חובה + קישור חיצוני.

#### **עדכון מערכת ההזמנות:**
- **פענוח קוד הזמנה:** המערכת מפענחת את 12 הספרות (עסק+טלפון+רנדום)
- **זיהוי המזמין:** חיפוש בטבלת `customers` לפי 4 ספרות אחרונות של טלפון ועסק
- **שליחה אוטומטית:** יצירת רשומה בטבלת `referrals` עם פרטי המזמין והמוזמן

- טיפול בטופס:
  - ולידציות ברורות; מציג מודאל שגיאה טקסטואלי.
  - בדיקת קיום לקוח (`customers` לפי טלפון+קוד עסק).
  - אם קיים → `createCardWithProduct(product_code)`.
  - אם לא קיים → יצירת לקוח ואז יצירת כרטיסייה.
- יצירת כרטיסייה:
  - מבנה `card_number = businessCode + customerPhone + productCode`.
  - שליפה/ברירת מחדל ל-`max_punches` ו-`default_product` מתוך `businesses`.
  - אם `productCode === '00'`: וידוא קיום מוצר כללי '00', ואם חסר — יצירה ב-`products`.
  - בדיקה אם כרטיסיה קיימת; אם לא — יצירה בטבלת `PunchCards` עם `used_punches: 0, status: 'active'`.
- פונקציית עזר: `fixBusinessCodeAndAddDefaultProduct`
  - אם קוד עסק באורך 3 → הוספת '0' ועדכון כל הטבלאות המתאימות.
  - וידוא מוצר כללי '00'.
- בקשת הצטרפות עסק (מודאל):
  - אם לא נמצא עסק בחיפוש (מעל 3 תווים): טופס `business_requests` ומסר הצלחה.
- כפתורי ניווט עליונים: "← שנה עסק" מחזיר ל-`/business_selector`.

### 7) `app/(tabs)/PunchCard.tsx` — כרטיסיית ניקובים (מעודכן)
- פרמטר כניסה: `phone` ב-query.
- שליפה:
  - `customers` לפי `customer_phone` → מוציא `business_code`.
  - קובע `productCode` בקוד כ-`'12'` (קשיח כרגע).
  - בונה `card_number` ונטען `PunchCards` לפי `card_number`.
  - נטען `businesses` לפי `business_code` (כולל מותגים, אייקונים, צבעים, תאריך תפוגה).
- Realtime:
  - מאזין לשינויי `PunchCards` לפי `card_number` ולעדכוני `businesses` לפי `business_code` ומרענן.
- תצוגה:
  - תפריט המבורגר (שמאל עליון) — מודאל פריטים טקסטואלי שסוגר בלבד.
  - אייקון מייל (ימין עליון):
    - מודאל "הודעות" (דמו), כולל מונה "לא נקראו" שמאופס בסגירה.
    - **חדש: כשלוחצים על הודעת פוש בתיבה - מציג את השובר המלא**
  - אייקון "קהילה" (אמצע עליון) — **"חבר מביא חבר" מעודכן:**
    - **מציג קוד הזמנה מספרי חדש (12 ספרות)** במקום מספר כרטיסייה
    - העתקה ללוח עם התראות מעודכנות
    - כפתורי שיתוף מתקדמים (WhatsApp, Email, Facebook, Instagram) עם הודעות מותאמות
  - אזור עליון: לוגו + שם עסק; שם לקוח.
  - אזור מרכזי: גריד אייקונים מנוקבים/לא מנוקבים לפי `used_punches` ו-`max_punches` מהעסק.
  - טקסטים תחתונים: ניקובים X/XX, הטבה, "תשלום מראש", תאריך תפוגה.
  - ברקוד: CODE128 על בסיס `card_number`, ותצוגת המספר.
- טעינה/שגיאה:
  - "טוען נתונים..." במרכז.
  - הודעת שגיאה ידידותית והצעת ניווט חזרה לכניסה.

### 8) `app/(tabs)/thank_you.tsx` — מסך תודה לאחר רישום
- מציג לוגו ושם העסק, כותרות הסבר, Lottie במרכז.
- "×" (שמאל עליון): חזרה ל-`/customers-login`.
- "שנה עסק" (ימין עליון): חזרה ל-`/business_selector`.

### 9) `app/(tabs)/explore.tsx` — מסך דמו/תבנית
- דוגמת תצוגה עם `ParallaxScrollView`, `Collapsible`, הסברים על תבנית ריאקט-נאטיב/אקספו.
- לא מחובר לזרימת האפליקציה העסקית.

## תפריטים ופעולות — פירוט לפי מסך

- Business Selector — תפריט המבורגר:
  - כניסת בעלי עסקים: כרגע ללא ניווט (סגירה בלבד).
  - סרטון הסבר: כרגע ללא ניווט (סגירה בלבד).
  - צור קשר: כרגע ללא ניווט (סגירה בלבד).
  - מדיניות פרטיות: כרגע ללא ניווט (סגירה בלבד).
  - סגור: סוגר מודאל.

- Customers Login — פופאובר תפריט:
  - צ'וטט איתנו (WhatsApp): פותח `https://wa.me/{business_whatsapp}` אם קיים.
  - צלצל אלינו (Phone): פותח `tel:{business_phone}` אם קיים.
  - שתפ/י חבר/ה (WhatsApp): שיתוף הודעת טקסט עם שם העסק.
  - הגרלות והפתעות: לוג בלבד (עדיין לא ממומש).

- PunchCard — תפריט המבורגר (מודאל טקסטואלי):
  - הוראות שימוש, מדיניות פרטיות, הפעילות שלי, הפרופיל שלי, אודותינו, יציאה מהיישום, צור קשר: כרגע סוגר מודאל בלבד.

- PunchCard — מודאל "הודעות" (מעודכן):
  - רשימת הודעות דמו, "×" לסגירה, איפוס מונה הודעות לא נקראו.
  - **חדש: לחיצה על הודעת פוש מציגה שובר מלא (אם השובר בתוך ההודעה)**

- PunchCard — חלונית "חבר מביא חבר" (מעודכנת לחלוטין):
  - **קוד הזמנה מספרי חדש:** 12 ספרות (עסק+טלפון+רנדום)
  - העתקת קוד ללוח עם הודעות מעודכנות
  - כפתורי שיתוף משופרים עם הודעות מותאמות אישית:
    - WhatsApp: הודעה מותאמת עם קישור להורדה
    - Email: נושא וגוף מותאמים
    - Facebook: פוסט עם טקסט מלא
    - Instagram: (להוספה עתידית)

## מודל נתונים בשימוש

### טבלאות קיימות:
- `businesses`: `business_code`, `name`, `logo`, `login_brand_color`, `login_background_image`, `business_whatsapp`, `business_phone`, `max_punches`, `punched_icon`, `unpunched_icon`, `card_text_color`, `expiration_date`.
- `customers`: `name`, `customer_phone`, `business_code`.
- `products`: `business_code`, `product_code`, `product_name`, `product_type`, `price`.
- `PunchCards`: `card_number`, `business_code`, `customer_phone`, `product_code`, `total_punches`, `used_punches`, `status`, `benefit`, `prepaid`, timestamps.
- `business_requests`: בקשות הצטרפות של לקוחות לעסקים.

### **טבלאות חדשות למערכת חבר מביא חבר:**
- `referrals`: 
  - `id`, `inviter_phone`, `invited_phone`, `business_code`, `referral_date`
  - `reward_given`, `status` ('pending', 'completed'), `updated_at`
  - **`invitation_code`**: קוד הזמנה מספרי ייחודי
  - **`voucher_status`**: סטטוס השובר ('unused', 'used', 'expired')
  - **`voucher_expiry_date`**: תאריך תפוגת השובר
- `voucher_types`: (שוברי מערכת למזמין ולמוזמן)
- `referral_settings`: הגדרות מערכת ההזמנות לכל עסק

## מגבלות/סטטוס מימוש לפי קוד
- במסך כרטיסייה, `productCode` מקובע כ-`'12'` ולא דינמי לכל עסק/כרטיסייה.
- פריטי תפריט רבים מוגדרים תצוגתית בלבד (ללא ניווט/פעולה בפועל).
- אין אימות משתמשים/הרשאות בצד הלקוח; שימוש ב-anon key (RLS אמור להגן בצד ה-DB).
- **מערכת "חבר מביא חבר" פעילה ומלאה** - כולל יצירת קודים, שליחה לSupabase, ויצירת שוברים אוטומטית.

## זרימות משתמש עיקריות

### זרימת בחירה → כניסה → כרטיסייה:
1) פתיחה → Redirect ל-`/business_selector`.
2) לחיצה על "בחר עסק" → בחירת עסק → `setBusinessCode` → ניווט ל-`/customers-login`.
3) הזנת טלפון תקין → שמירה ב-`AsyncStorage` → ניווט ל-`/PunchCard?phone=...`.
4) בכרטיסייה: צפייה בניקובים, ברקוד, שיתוף קופון, הודעות, תפריט.

### זרימת הרשמה ללקוח חדש (מעודכנת):
1) במסך כניסה: "הרשמ/י לקבלת כרטיسייה" → `/newclient_form`.
2) מילוי פרטים + בחירת עסק + בחירת מוצר + **הכנסת קוד הזמנה (אופציונלי)** + אישור מדיניות.
3) **אם יש קוד הזמנה:** המערכת מפענחת, מזהה מזמין, ושולחת לטבלת `referrals`
4) בדיקת קיום לקוח בעסק:
   - אם קיים → יצירת כרטיסייה עם המוצר הנבחר.
   - אם לא → יצירת לקוח ואז יצירת כרטיסייה.
5) ניווט ל-`/thank_you`.
6) סגירה × → חזרה לכניסה; "שנה עסק" → חזרה לבחירת עסק.

### **זרימת "חבר מביא חבר" החדשה:**
1) בכרטיסייה: לחיצה על אייקון קהילה.
2) **הצגת קוד הזמנה מספרי (12 ספרות)** + העתקה ללוח.
3) שיתוף דרך WhatsApp/Email/Facebook עם הודעות מותאמות אישית.
4) חבר חדש נרשם עם הקוד → **שליחה אוטומטית לSupabase**.
5) **יצירת שוברים אוטומטית:** Supabase יוצר 2 שוברים (מזמין + מוזמן).
6) **קבלת שוברים:** הודעות פוש נשלחות ונשמרות בתיבת דואר נכנס.
7) **הצגת שובר:** לחיצה על הודעה בתיבה מציגה את השובר המלא.

### זרימת תמיכה/קשר (לקוחות):
- במסך הכניסה: פופאובר → WhatsApp/טלפון/שיתוף.

## פרטים טכניים רלוונטיים
- `app.json`: מפעיל plugins של `expo-router`, `expo-splash-screen`, `expo-web-browser`.
- `expo` תומך ב-web עם `bundler: metro`.
- תלותים מרכזיים: `@supabase/supabase-js@^2`, `react-native-svg-barcode`, `lottie-react-native`, `expo-clipboard`, `@react-native-async-storage/async-storage`.

## סיכום מעודכן 2024

### מה מיפיתי ותיעדתי:
- כל המסכים: `business_selector`, `customers-login`, `newclient_form`, `PunchCard`, `thank_you`, ו-`explore`.
- כל תפריט ופריט פעולה ומה קורה בפועל לפי הקוד.
- כל הזרימות המרכזיות והטבלאות הנצרכות.

### **עדכונים חדשים למערכת חבר מביא חבר:**
- **קוד הזמנה מספרי:** 12 ספרות ייחודיות (עסק+טלפון+רנדום)
- **שילוב מלא עם Supabase:** שליחה אוטומטית ויצירת שוברים
- **ממשק משופר:** הודעות מותאמות אישית לכל רשת חברתית
- **מעקב מלא:** זיהוי מזמין, יצירת שוברים, מעקב שימוש
- **התאמה לברקוד:** קוד מספרי מלא מתאים לסריקה וברקוד

---
*מסמך זה עודכן בדצמבר 2024 עם מערכת חבר מביא חבר מלאה ופעילה.*






