---
alwaysApply: true
---

# 🎯 כללי עבודה מאוחדים - CARDZ ADMIN
**פרויקט בשלב פרה-ייצור - רגישות מקסימלית נדרשת**

> **מודל נוכחי**: יש לציין בתחילת כל שיחה (לדוגמה: Claude Sonnet 4.5)
>
> **דומיין פרודקשן**: `https://punchcards.digital`

---

## 🏭 הוראות קריטיות - שלב פרה-ייצור
**קרא קודם! זה החשוב ביותר**

**הפרויקט ממש לפני שלב ייצור - כל שינוי עלול להשפיע על לקוחות אמיתיים!**

### כלל מבוא:

**היה בטוח שקראת את כל הקוד והתלויים הרלוונטים לטיפול כולל הלוגיקה העסקית והפלואו המובנה המשרת לוגיקה זו. אם יש ספק - אין ספק - שאל את המשתמש להשלמת התמונה החסרה/הנדרשת, שאתה צריך.**

### חמש דרישות מחייבות לכל שינוי:

**1. אבחון מדויק ביותר**
- זיהוי מדויק של הבעיה/דרישה - ללא קיצורי דרך
- מעקב מסודר אחר זרימת הקוד הרלוונטית
- אבחון שורש הבעיה, לא רק הסימפטומים
- **אסור לנחש** - אם משהו לא ברור, לשאול

**2. ניתוח עמוק ומלא של תלויים והשפעות רוחב**
- **חובה:** זיהוי כל הקבצים והפונקציות שעלולים להיות מושפעים
- **חובה:** בדיקת השפעה על ממשק הקליינט (React Native App)
- **חובה:** בדיקת השפעה על מסד הנתונים (Supabase, RLS policies)
- **חובה:** בדיקת השפעה על Edge Functions
- **חובה:** בדיקת תאימות לאחור (Backward Compatibility)
- **אסור לרוץ קדימה** - לתכנן ולבדוק לפני ביצוע

**3. הערכת סיכונים והחלטת משתמש**
- **לפני כל שינוי מבני/מורכב:**
  - להציג למשתמש את כל הסיכונים הפוטנציאליים
  - להציע חלופות בטוחות יותר
  - לקבל אישור מפורש לפני ביצוע
  
- **קוד מורכב שעלול לגרום לתקלות:**
  - להביא לידיעת המשתמש לפני ביצוע
  - להסביר את המורכבות והסיכונים
  - לבקש החלטה מפורשת

**4. אחריות מקצועית**
- **אסור לשבור קוד עובד** - אם זה לא שבור, אל תתקן
- אסור לשנות תפקוד פונקציות קיימות ללא אישור
- אסור לבצע שינויים "נסיוניים" בפרודקשן
- חובה לבדוק תלויים לפני כל שינוי
- **לדווח על כל בעיה** - גם קטנה, מיד כשמתגלה

**5. גיבוי לפני שינויים משמעותיים**
- תמיד לשמור גיבוי לפני שינוי משמעותי
- **חובה לשאול את המשתמש:** גיבוי מלא או לנקודת שחזור?
- **לפרטים מלאים:** ראה `.cursor/rules/backup_rules.md`

**📌 הערה חשובה:** הדרישות לעיל (1-5) מתייחסות לשלב הפרה-ייצור ויש ליישם אותן בכל המסמך. תוכן העניינים להלן (סעיפים 1-5) מנחה את מבנה המסמך.

---

## 📋 תוכן עניינים

1. [פרוטוקול התחלה חובה](#1-פרוטוקול-התחלה-חובה) - **לקרוא ולמלא בכל תחילת שיחה**
2. [מנגנון בקרת ציותנות](#2-מנגנון-בקרת-ציותנות) - **לבדוק לפני כל שינוי קוד**
3. [חוקי עבודה בסיסיים](#3-חוקי-עבודה-בסיסיים) - **DO ו-DON'T מרכזיים**
4. [טיפול בבאגים ותקלות](#4-טיפול-בבאגים-ותקלות) - **תהליך שיטתי לפתרון בעיות**
5. [טכנולוגיות ופתרון בעיות](#5-טכנולוגיות-ופתרון-בעיות) - **Push/FCM, Supabase, TypeScript**

**📚 מסמכים נוספים:**
- **גיבוי ושחזור:** `.cursor/rules/backup_rules.md` - **חובה לשאול: גיבוי מלא או לנקודת שחזור?**

---

## 1. פרוטוקול התחלה חובה

### א. קריאה אמיתית
**חובה מוחלטת בתחילת כל שיחה:**
- קרא את קובץ זה בפועל עם חיווי "reading" (גלגל מסתובב)
- **אסור** למלא את הפרוטוקול ללא קריאה אמיתית

### ב. פרוטוקול אישור
הצג למשתמש:
```
🔍 קראתי את UNIFIED_AGENT_RULES.md בפועל: כן
📝 אני מאשר את כל החוקים שקראתי: כן
⚠️ אני מחוייב בדיווח אמת ולא אשקר: כן
🎯 הבנתי את מנגנון בקרת הציותנות: כן
⚡ אבצע קריאה חוזרת אם לא קראתי: כן
🏭 הבנתי שהפרויקט בשלב פרה-ייצור ודורש רגישות מקסימלית: כן
```

### ג. אכיפה
- **אסור לבצע שום פעולה** לפני השלמת שלבים א'+ב'
- **אסור לענות על שאלות** לפני מילוי הפרוטוקול
- **אסור לשנות קוד** לפני אישור החוקים

### ד. מנגנון אכיפה עצמית
- אם אין חיווי ברור שקראתי → חוזר וקורא
- אם לא מילאתי את הפרוטוקול → עוצר ומבצע קריאה
- אם זיהיתי שלא עמדתי בחוקים → מודיע מיד

---

## 2. מנגנון בקרת ציותנות

### א. בדיקה חובה לפני כל שינוי/עריכה/מחיקה של קוד

**יש לכתוב ולהציג למשתמש:**

```
☐ קראתי את הבקשה המדויקת ללא פרשנות: [מה בדיוק התבקשתי לעשות]
☐ שמרתי את המצב הקודם בזיכרון זמני לשחזור: [איך אשחזר במקרה של בעיה]
☐ זיהיתי את הקבצים/קוד שאסור לי לגעת בהם: [מה לא לגעת]
☐ זיהיתי בדיוק מה צריך למחוק/לשנות: [מה בדיוק אמחק/אשנה]
☐ וידאתי שאני לא מוסיף יוזמות שלא התבקשו: [מה לא אוסיף]
☐ בדקתי תלויים והשפעות רוחב: [CSS, קומפוננטות, ממשק קליינט, DB]
☐ תכננתי צעדים קטנים עם בדיקות ביניים: [איך אבצע בצעדים]
☐ בדקתי שאני לא משנה פונקציונליות עובדת: [מה לא אשנה]
```

**🚫 אסור לבצע שום פעולת קוד לפני:**
- מילוי כל התיבות
- קבלת אישור מהמשתמש (אם נדרש)

### ב. שמירת מצב קודם - חובה

לפני כל שינוי קוד:
- לקרוא את הקוד הנוכחי
- לשמור בזיכרון זמני
- לדעת איך לשחזר במקרה של בעיה

---

## 3. חוקי עבודה בסיסיים

### א. עקרונות DO (לעשות)

- **מיקוד והתמקדות**
  - להתרכז רק בטיפול הבקשה
  - ללא יוזמה לא מאושרת של תוספות/שינויים/שיפורים
  - לא להוסיף הודעות מערכת ללא אישור

- **שינויים מינימליים**
  - רק את מה שהתבקש באופן מפורש
  - לא יותר ולא פחות
  - אם יש יוזמה נוספת - לבקש אישור

- **שמירה על קוד עובד**
  - אין לגעת בקוד שעובד ללא אישור מראש
  - גם אם יש דרך "טובה יותר" - לא לשנות ללא אישור
  - (אבל בהחלט מותר להמליץ)

- **תקשורת ברורה**
  - שאלה (לא בקשה) → תשובה קצרה וענינית ללא דוגמאות קוד
  - בקשות מרובות → למפות ולטפל אחת אחת ללא דילוג
  - לפעול בדיוק לפי הבקשות

- **ביצוע עצמאי**
  - לבצע בעצמי כל פעולות קידוד/טרמינל/Supabase/SQL
  - לא להפעיל את המשתמש במקרים שיש גישה והרשאה
  - לחסוך זמן למשתמש

### ב. עקרונות DON'T (לא לעשות)

- **איסור יוזמות**
  - לא לבצע פעולות ביוזמה עצמית
  - אם צריך לשנות משהו נגזר/מושפע → להציג לאישור לפני ביצוע
  - לפעול רק לפי הוראות מדויקות ומפורשות

- **איסור שינוי תחומי עבודה**
  - שינוי UI ← אין לגעת בלוגיקה עסקית
  - שינוי פונקציונאלי ← אין לגעת ב-UI אחר
  - אין לגעת בקוד אחר/ממשק אחר/פונקציה אחרת/דף אחר ללא אישור

- **איסור שינוי לוגיקה עסקית**
  - לא לשנות מבנה עסקי ביוזמה עצמית
  - לא ליצור פתרונות מסובכים מדי
  - לשמור על פשטות בקוד

- **איסור תוספות לא מבוקשות**
  - לא להוסיף טקסט הסבר, כפתורים, אלמנטים, פונקציות
  - אם מרגיש נחיצות → לדווח ולבקש אישור
  - לא לשנות פונקציונליות מעבר למבוקש

- **איסור מוחלט על שקרים ו"המצאות"**
  - אסור לתת תשובות שאתה "ממציא"
  - אם משהו לא ברור/לא מאותר → לחזור למשתמש ולבקש השלמה
  - אם לא יודע לשחזר/להחזיר מהלך → לדווח ולא לבנות מחדש
  - **דיווח אמת בלבד - שום שקר לא יתקבל**

### ג. ניהול קבצים

- ליצור קבצים חדשים במידת הצורך והסדר הלוגי
- לא להרחיב קבצים קיימים בנושאים לא קשורים
- לשמור על קבצים ממוקדים וקצרים
- תיקון לא התבצע? → למחוק את המהלך האחרון ולא להשאיר שאריות

### ד. תיקון שגיאות בנייה

- אם יש שגיאות → לתקן אותן
- ללא השפעה על פונקציונליות או נראות אחרים
- לשמור על יציבות המערכת

### ה. עקרון המנחה המרכזי

**"לבצע בדיוק את מה שהמשתמש מבקש - לא יותר ולא פחות"**

---

## 4. טיפול בבאגים ותקלות

### א. תהליך פתרון בעיות - שיטתי ומסודר

**עליך לבצע (לפי הסדר):**

- **זיהוי מדויק של הבעיה**
  - מה הבעיה בדיוק?
  - איפה היא קורית?
  - מתי היא החלה?

- **מעקב מסודר אחר זרימת הקוד הרלוונטית**
  - איזה קבצים מעורבים?
  - איזה פונקציות?
  - מה הזרימה המלאה?

- **שינויים מינימליים הכרחיים בלבד**
  - רק מה שדרוש לתיקון הבעיה
  - לא "בעת מקום" לשיפורים אחרים

- **בדיקה מקדמית שהשינויים לא יפגעו**
  - בפונקציונליות קיימת
  - ב-UI קיים
  - בממשק הקליינט
  - במסד הנתונים

**המנע מלנסות לתקן דברים שאינם בעייתיים לעניין הבעיה!**

### ב. טיפול בבעיות חוזרות

**אם קיים קושי לבצע שינוי יותר מפעם אחת:**

- **לעצור ניסיונות** - לא להמשיך באותה השיטה

- **לבצע בדיקה לוגית מתודית יסודית:**
  - מיפוי הפלואו המלא
  - בדיקת קודים אחרים שאולי מפריעים
  - סקירת כל הבעיות האפשריות

- **להביא בפני המשתמש:**
  - את האפשרויות לפיתרון
  - המלצה מהיכן להתחיל
  - הסיכונים והסיכויים של כל אפשרות

**המנע מהבנה שגויה ללא בדיקה מעמיקה:**
- אל תשלוף תשובות מוכנות ללא בדיקה
- הבעיה חוזרת? → ממפה לוגים ומבקש את התשובות מהמשתמש
- תמיד להתמקד בבעיה העיקרית

### ג. כשמשהו לא עובד - פרוטוקול

- **הפסקה מיידית** - לא להמשיך לשבש
- **בדיקה מתודית** של הבעיה
- **שחזור למצב עובד** אם אפשר
- **דיווח כנה** למשתמש על המצב - אסור לשקר או להמציא
- **בקשת הנחיה** לפני המשך

---

## 5. טכנולוגיות ופתרון בעיות

### א. Push / FCM - פרוטוקול ייצור יציב

**רכיבים:**
- `register-device-token` (Edge Function): רושמת FCM token ל-`device_tokens`
- `fcm-dispatch` (Edge Function): שולחת פוש דרך FCM HTTP v1

**Endpoints:**
- POST `https://noqfwkxzmvpkorcaymcb.functions.supabase.co/register-device-token`
- POST `https://noqfwkxzmvpkorcaymcb.functions.supabase.co/fcm-dispatch`
- Headers: `Authorization: Bearer <ANON_KEY>`, `Content-Type: application/json`

**שליחה מומלצת (v1 ישיר):**
```json
{
  "business_code": "0002",
  "tokens": ["<FCM_TOKEN>"],
  "notification": { "title": "כותרת", "body": "תוכן" },
  "data": { "type": "test", "timestamp": "1729594000" },
  "android": { "priority": "HIGH", "notification": { "sound": "default" } }
}
```

**כללי נתונים:**
- לא להשתמש במפתחות שמורים (למשל `from`) בתוך `data`
- Service Account נשמר ב-Supabase (לא ברפו)

**דיאגנוסטיקה:**
- `?debug=1` ל-`fcm-dispatch` + `business_code` מחזיר מצב טעינת SA
- שגיאות נפוצות: `UNREGISTERED`, `INVALID_ARGUMENT`

### ב. בעיות TypeScript/Build

**עצירה במקרה של לולאה:**
- מקסימום 3 ניסיונות תיקון באותו קובץ
- אחר כך - דיווח למשתמש ובקשת הנחיה

**כללי טיפול:**
- Missing imports: תמיד לבדוק נתיבים
- Type errors: לא לנחש - לבדוק הגדרות
- Build failures: לתקן לפני commit, לא אחריו

### ג. טכנולוגיות נוספות

**סביבת העבודה:**
- Windows 10 + PowerShell
- נתיב: `C:\cardz_curser\cards-admin-web`
- פרויקט: React/Vite (ווב), לא Expo
- להריץ: `npm run dev` (לא `expo run:android`)

**Supabase:**
- לבצע שאילתות SQL בעצמי כשיש צורך
- לא לבקש מהמשתמש להריץ אותן
- להשתמש ב-Edge Functions ו-RLS policies

**MCP כלים:**
- 3 כלי MCP זמינים
- להשתמש בהם ביוזמה במקרים של בדיקת תיקון שלא בוצע

**טרמינל:**
- בדיקת סביבת הטרמינל לפני הרצת פקודות
- בדיקת תחביר נכון והתאמה לסביבה
- במקרה של תקיעה: לזהות, לסגור טרמינלים ברקע, לרענן, לדווח

---

## 🚨 הערות חשובות לזכור

### עקרונות מנחים:

1. **תמיד לשמור מצב קודם עובד** לפני שינויים
2. **לבדוק כל שלב** לפני המעבר לבא אחריו
3. **לדווח כנה** על בעיות - אסור לשקר או להמציא
4. **במקרה של כישלון** - לא להמשיך, לבדוק את השגיאה
5. **פרה-ייצור = זהירות מקסימלית** - כל שינוי משפיע
6. **גיבוי לפני שינויים משמעותיים** - שאל: גיבוי מלא או לנקודת שחזור? ראה `.cursor/rules/backup_rules.md`

### זכור תמיד:

- סביבת העבודה: Windows 10 + PowerShell ב-`C:\cardz_curser\cards-admin-web`
- בדיקת תחביר וסביבת טרמינל לפני הרצת פקודות
- 

---

**📅 מסמך מאוחד נוצר:** 2025-01-08  
**📋 מטרה:** מדריך מקיף ומאוחד לעבודה יומיומית בטוחה ויעילה בשלב פרה-ייצור  
**🔄 מקור:** איחוד של 5 קבצי חוקים (general.mdc, basicrules.mdc, genegal_basice_rules.md, general_agent_working_instructions.md, AUTO_START.md)
