# 📋 דוח איכות ואבטחה – 08/11/2025 23:05

## תקציר מנהלים
בסקירה מקיפה של קוד הלקוח נמצאו מספר בעיות קריטיות שדורשות טיפול מיידי לפני הפצה לייצור: חשיפת פרטי התחברות ל-Supabase בתוך הריפו, ריבוי לוגים שמדפיסים נתונים רגישים (מספרי טלפון, business_code, טוקנים), ופתיחת קישורים מהודעות push ללא בדיקת סכימת ה-URL. בנוסף זוהו נקודות חולשה נוספות שעלולות לפגוע ביציבות האפליקציה ובשמירת פרטיות המשתמשים. הדוח להלן מסכם את הממצאים לפי חומרתם.

## ממצאים קריטיים (לטיפול מיידי)
- **חשיפת מפתחות Supabase בקוד** (`components/supabaseClient.ts`, `shared-mcp-server/agents-comm.js`):
  - URL ו-Anon Key של Supabase נמצאים בקוד כערכי ברירת מחדל. מי שמקבל גישה לריפו יכול לבצע קריאות מלאות ל-DB. יש להסיר מהקוד, להעביר ל-secretים, ולסובב מפתחות קיימים.
- **לוגים עם נתונים רגישים** (`app/(tabs)/PunchCard.tsx`, `components/FCMService.ts`, `app/(tabs)/customers-login.tsx`):
  - מודפסים business_code, מספרי טלפון, טוקנים ונתוני הודעות מלאים. לוגים כאלה נכנסים ל-crash reports ועלולים לדלוף. נדרש לנקות לוגים לפני שחרור לייצור.
- **פתיחת קישורים מהודעות push ללא וולידציה** (`app/(tabs)/PunchCard.tsx`):
  - הקוד פותח URL שמגיע מהודעה ללא בדיקת סכימה או דומיין. תוקף יכול לשלוח `javascript:` או `intent://`. חובה להגביל ל-https ולדומיינים מאושרים.

## ממצאים חשובים נוספים
- **שמירת נתונים רגישים ב-AsyncStorage ללא הצפנה** (`app/(tabs)/customers-login.tsx`, `index.js`):
  - מספרי טלפון והודעות Push נשמרים כטקסט גלוי. מומלץ לעבור ל-Expo SecureStore או להצפין ידנית.
- **לוגים של תגובות Edge Functions** (`components/FCMService.ts`):
  - מודפס כל ה-response מהפונקציות, כולל מזהים וטלפונים. להשאיר רק ברמת DEBUG או להסיר.
- **UI Debug Panel נגיש למשתמשים** (`app/(tabs)/PunchCard.tsx`):
  - חלון debugInfo מוצג למשתמשים עם פרטי URL וטלפון. יש להסתיר או לנטרל בייצור.

## ריחות קוד ונקודות לשיפור
- **card_number מחושב באמצעות קונקטציה** (`app/(tabs)/newclient_form.tsx`):
  - חיבור businessCode+phone+productCode ללא בדיקת אורך/חוסן. עלול ליצור כפילויות או חריגות. מומלץ להשתמש ב-hash או הגבלת אורך.
- **normalizePhone מחזיר מחרוזת חתוכה** (`components/FCMService.ts`):
  - חיתוך אוטומטי ל-10 ספרות גם אם המספר קצר מדי → הכנסת ערכים שגויים לשרת.
- **חוסר טיפול בשגיאות טעינת עסק** (`components/BusinessContext.tsx`):
  - במקרה של שגיאה ה-business נשאר null ללא הודעת משתמש. מומלץ להוסיף fallback.
- **סקריפטים שמדפיסים מפתחות** (`tools/check_remaining_keys.js` וכו'): 
  - לוודא שמיועדים לסביבת dev בלבד.

## בדיקות שלא בוצעו
- אין בדיקות יחידה/אינטגרציה בפרויקט.
- לא הורצו כלי SAST/DAST אוטומטיים; הסקירה בוצעה ידנית בלבד.

## המלצות המשך
- להסיר מפתחות מהקוד, לסובב אותם ולהשתמש ב-.env מוצפן.
- לנקות את כל לוגי ה-console עם נתונים מזהים או לעטוף ב-`__DEV__`.
- להגביל פתיחת קישורים לדומיינים רשמיים ולסכימות `https` בלבד.
- לעבור לאחסון מאובטח (SecureStore/הצפנה) עבור נתוני משתמש.
- להוסיף בדיקות יחידה לפונקציות קריטיות (ניקוי טלפון, יצירת כרטיסיה).
- להפעיל lint/formatter שיזהה לוגים רגישים לפני build (pre-commit hook).

> דוח זה מתעד ממצאים בלבד; לא בוצעו תיקונים בפועל בהתאם להנחיות.

---

## מיפוי קבצים זמניים – נדרשת בדיקה לפני מחיקה

להלן קבצים/תיקיות שסומנו כמועמדים למחיקה אך נדרשת בדיקה לפני פעולה:

- shared-mcp-server/**
  - תשתית MCP פנימית. למחיקה רק אם הוחלט שאינה בשימוש בסביבה הנוכחית.

- .cursor/**
  - קבצי כללים/הנחיות פנימיים לתהליך עבודה. למחוק רק אם הוחלט שאינם דרושים בריפו הלקוח.

- assets/icons/deleet.png
  - איקון חשוד כיתום/כפול. יש לאמת שימוש בפועל לפני מחיקה.

- assets/icons/עיצוב ללא שם (26).png
  - שם קובץ זמני/מיובא. יש לאמת שימוש בפועל לפני מחיקה.

- docs/**, FCM_ADMIN_INSTRUCTIONS.md
  - תיעוד פנימי/הנחיות. למחוק רק אם מדיניות הריפו מחייבת צמצום קבצי תיעוד.

- assets/Projet defenitions/**
  - מסמכי אפיון/תיעוד. למחיקה רק אם הוחלט שמועברים למאגר תיעוד נפרד.
