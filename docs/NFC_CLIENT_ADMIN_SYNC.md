# 📋 מסמך תיאום קליינט-אדמין: NFC Punch Flow
## עדכון: 11/12/2025

---

## 1. 🎯 החלטות שהתקבלו

### 1.1 מי מבצע את הניקוב (UPDATE ל-Supabase)?

| # | תרחיש | מי יוזם | מי מאשר | מי מבצע UPDATE |
|---|-------|---------|---------|----------------|
| 1 | Prepaid + מזוהה + 1 כרטיסייה | קליינט | אין צורך | **קליינט** |
| 2 | Prepaid + מזוהה + >1 כרטיסיות | קליינט (אחרי בחירה) | אין צורך | **קליינט** |
| 3 | Prepaid + לא מזוהה | קליינט (אחרי הזדהות) | אין צורך | **קליינט** |
| 4 | לא Prepaid + שלח בקשה | קליינט | **אדמין מאשר** | **אדמין** |
| 5 | ניקוב ידני (ברקוד/ידני) | אדמין | אדמין | **אדמין** |

**כלל פשוט:** האחראי על ביצוע הניקוב = מי שגורם לו להתבצע

---

### 1.2 הגדרת "מזוהה"

- **מזוהה** = לקוח שביצע הזדהות ביומטרית (Face ID / Touch ID / טביעת אצבע)
- **לא מזוהה** = לקוח שנכנס רק עם מספר טלפון (ללא ביומטריה)
- אם לא מזוהה → מציגים בקשת הזדהות ביומטרית

---

### 1.3 מצבים מיוחדים

| מצב | טיפול | אחראי |
|-----|-------|-------|
| **ניקוב ידני (punch_mode=manual)** | הודעת חסימה - לא ניתן לבצע NFC | קליינט |
| **כרטיסייה מלאה** | הודעה + שאלה לפתוח כרטיסייה חדשה | קליינט |
| **ניקוב מזכה (הגיע להטבה)** | קונפטי + סאונד → מודאל חידוש | קליינט |

---

## 2. ❓ שאלות פתוחות לאדמין

### שאלה 1: לוג פעילות (activity_logs)
**מי אחראי על הוספת רשומה ל-activity_logs?**

- [ ] הקליינט (כשמבצע ניקוב Prepaid)
- [ ] האדמין (תמיד)
- [ ] שניהם (כל אחד כשהוא מבצע)

**המלצת הקליינט:** כל אחד מוסיף לוג כשהוא מבצע את הניקוב

---

### שאלה 2: עדכון Realtime לקליינט
**כשהאדמין מבצע ניקוב (לא Prepaid), האם הוא שולח עדכון Realtime לקליינט?**

- האם דרך `punch_requests.status = 'completed'`?
- או דרך ערוץ אחר?

**הקליינט מאזין ל:** `punch_requests` (שינויי status)

---

### שאלה 3: ניקוב מזכה
**כשהאדמין מבצע ניקוב שמזכה בהטבה:**

- האם האדמין שולח אינדיקציה מיוחדת לקליינט?
- או שהקליינט בודק בעצמו אם `new_punches >= total_punches`?

**המלצת הקליינט:** הקליינט יבדוק בעצמו לאחר קבלת עדכון Realtime

---

### שאלה 4: פתיחת כרטיסייה חדשה
**כשלקוח מאשר פתיחת כרטיסייה חדשה (אחרי שהכרטיסייה מלאה):**

- מי יוצר את הכרטיסייה החדשה?
- [ ] הקליינט (INSERT ל-PunchCards)
- [ ] האדמין

---

## 3. 📊 זרימת נתונים

### 3.1 Prepaid - קליינט מבצע:

```
סריקת NFC
    │
    ▼
[קליינט] בדיקת מזוהה/לא מזוהה
    │
    ▼ (אם לא מזוהה)
[קליינט] בקשת הזדהות ביומטרית
    │
    ▼
[קליינט] בדיקת כמות כרטיסיות
    │
    ▼ (אם >1)
[קליינט] הצגת מסך בחירה
    │
    ▼
[קליינט] בדיקת כרטיסייה מלאה
    │
    ▼ (אם מלאה)
[קליינט] הודעה + שאלה לפתוח חדשה
    │
    ▼
[קליינט] UPDATE PunchCards (used_punches + 1)
[קליינט] INSERT activity_logs
    │
    ▼
[קליינט] בדיקת ניקוב מזכה
    │
    ▼ (אם מזכה)
[קליינט] קונפטי + סאונד + מודאל חידוש
    │
    ▼
[קליינט] הודעת הצלחה
```

### 3.2 לא Prepaid - שליחה לאדמין:

```
סריקת NFC
    │
    ▼
[קליינט] בדיקות + בחירות (כמו Prepaid)
    │
    ▼
[קליינט] INSERT punch_requests (status='pending')
    │
    ▼ Supabase Realtime
[אדמין] קבלת בקשה + מודאל אישור
    │
    ▼ (אדמין מאשר)
[אדמין] UPDATE PunchCards
[אדמין] INSERT activity_logs
[אדמין] UPDATE punch_requests (status='completed')
    │
    ▼ Supabase Realtime
[קליינט] קבלת אישור
[קליינט] בדיקת ניקוב מזכה → קונפטי + סאונד
[קליינט] הודעת הצלחה
```

---

## 4. ✅ פעולות נדרשות

### קליינט:
- [ ] יצירת פונקציית ניקוב ישיר (לPrepaid)
- [ ] טיפול בכרטיסייה מלאה
- [ ] טיפול בניקוב מזכה (קונפטי + סאונד)
- [ ] הבחנה בין מזוהה/לא מזוהה
- [ ] עדכון NFCPunchModal

### אדמין:
- [ ] אישור הזרימה המוצעת
- [ ] מענה על השאלות הפתוחות
- [ ] וידוא Realtime עובד

---

## 5. 📝 היסטוריה

| תאריך | עדכון |
|-------|-------|
| 11/12/2025 | מסמך ראשוני - החלטות והגדרות |



