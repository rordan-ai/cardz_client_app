# 📋 פרומפט לסוכן אדמין - פיצ'ר ניקוב NFC/ברקוד

## 🎯 קונטקסט

אפליקציית הקליינט (Cardz) מממשת כרגע פיצ'ר ניקוב באמצעות NFC. **אתה צריך לממש את הצד של האדמין** - קבלת בקשות ניקוב, אישור/דחייה, וביצוע הניקוב בפועל.

**חשוב:** אותו פלואו בדיוק ישמש גם לסריקת ברקוד על ידי האדמין, אז תכנן את הקוד בהתאם (reusable).

---

## 🔄 פלואו ניקוב - 15 מצבים

### משתנים קובעים:
1. **סטטוס תשלום:** שולם מראש (Prepaid) / לא שולם מראש
2. **כמות כרטיסיות:** כרטיסייה אחת / יותר מכרטיסייה אחת
3. **זיהוי לקוח:** זוהה (ביומטרי) / לא זוהה

### מצבי ניקוב אוטומטי:

| # | תשלום | כרטיסיות | זיהוי | פלואו |
|---|-------|----------|-------|-------|
| 1 | ✅ Prepaid | 1 | זוהה | הצמדה → ניקוב אוטומטי → הודעות לצדדים |
| 2 | ✅ Prepaid | 1 | לא זוהה → זוהה | הצמדה → בקשת הזדהות → זוהה → ניקוב אוטומטי → הודעות |
| 3 | ✅ Prepaid | 1 | לא זוהה → מספר ידני | הצמדה → בקשת הזדהות → מספר ידני → ניקוב אוטומטי → הודעות |
| 4 | ✅ Prepaid | >1 | זוהה | הצמדה → בחירת כרטיסייה → ניקוב אוטומטי → הודעות |
| 5 | ✅ Prepaid | >1 | לא זוהה → זוהה | הצמדה → בקשת הזדהות → זוהה → בחירה → ניקוב אוטומטי → הודעות |
| 6 | ✅ Prepaid | >1 | לא זוהה → מספר | הצמדה → בקשת הזדהות → מספר → בחירה → ניקוב אוטומטי → הודעות |
| 7 | ❌ לא Prepaid | 1 | זוהה | הצמדה → **אישור אדמין** → ניקוב אוטומטי → הודעות |
| 8 | ❌ לא Prepaid | 1 | לא זוהה → זוהה | הצמדה → הזדהות → **אישור אדמין** → ניקוב → הודעות |
| 9 | ❌ לא Prepaid | 1 | לא זוהה → מספר | הצמדה → הזדהות → מספר → **אישור אדמין** → ניקוב → הודעות |
| 10 | ❌ לא Prepaid | >1 | זוהה | הצמדה → בחירה → **אישור אדמין** → ניקוב אוטומטי → הודעות |
| 11 | ❌ לא Prepaid | >1 | לא זוהה → זוהה | הצמדה → הזדהות → בחירה → **אישור אדמין** → ניקוב → הודעות |
| 12 | ❌ לא Prepaid | >1 | לא זוהה → מספר | הצמדה → הזדהות → מספר → בחירה → **אישור אדמין** → ניקוב → הודעות |

### מצב ניקוב חצי-אוטומטי:
אותו פלואו בדיוק, אבל **תמיד** נפתח מודאל ניקוב ידני לאדמין בסוף (גם ל-Prepaid).

### מצב ניקוב ידני:
האדמין מחפש לקוח ידנית ומנקב - ללא NFC/ברקוד.

---

## 📝 מה האדמין צריך לממש

### 1. Supabase Schema
הרץ את הסקריפט: `docs/SUPABASE_NFC_SCHEMA.sql`
- עמודה `nfc_string` בטבלת businesses
- עמודה `punch_mode` בטבלת businesses
- טבלה `punch_requests` עם Realtime

### 2. הגדרות עסק (UI)
- **שדה מחרוזת NFC:** האדמין מזין מחרוזת ייחודית
- **בדיקת כפילויות:** קריאה ל-`check_nfc_string_exists()` לפני שמירה
- **בחירת מצב ניקוב:** radio buttons - ידני/חצי-אוטומטי/אוטומטי

### 3. האזנה לבקשות ניקוב (Realtime)
```typescript
// האזנה לבקשות חדשות
supabase
  .channel('punch_requests')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'punch_requests',
    filter: `business_id=eq.${businessId}`
  }, handleNewPunchRequest)
  .subscribe();
```

### 4. מודאל אישור ניקוב
כאשר מגיעה בקשה עם `is_prepaid=false`:
- הצגת פרטי לקוח וכרטיסייה
- כפתור "אשר ניקוב" → עדכון status ל-`approved`
- כפתור "דחה" → עדכון status ל-`rejected`
- Timeout אוטומטי אחרי 60 שניות

### 5. ביצוע הניקוב בפועל
לאחר אישור (או אוטומטית ל-Prepaid):
- עדכון הכרטיסייה (הוספת ניקוב)
- עדכון לוג פעילות לקוח (נשמר שנה)
- שליחת Push ללקוח: "בוצע ניקוב ע"י [שם העסק] בתאריך DD/MM/YYYY"
- עדכון status ב-punch_requests ל-`completed`

### 6. הודעות מערכת לאדמין
- "בוצע ניקוב" - הודעה בכל ניקוב (גם אוטומטי)
- סטטיסטיקות (אופציונלי) - כמה ניקובים היום

---

## 🔔 הודעות קבועות (מהקליינט)

| אירוע | הודעה |
|-------|-------|
| בחירת כרטיסייה | "נמצאה יותר מכרטיסייה אחת, נא בחר/י את כרטיסיית המוצר לניקוב" |
| הזדהות ביומטרית | "מעוניינים להזדהות באופן ביומטרי? כך לא תידרשו להקיש את מספר הטלפון שלכם מעתה ולתמיד" |
| ממתין לאישור | "מחכה לאישור ממסוף העסק!" |
| Timeout | "יתכן שיש בעיית תקשורת או שבית העסק השתהה באישור הניקוב, נסה שוב" |
| ניקוב בוצע | Push: "בוצע ניקוב ע"י [שם העסק] בתאריך DD/MM/YYYY" |

---

## 📊 מבנה בקשת ניקוב (punch_requests)

```typescript
interface PunchRequest {
  id: string;
  business_id: number;
  customer_phone: string;
  card_id: number;
  product_name: string;
  is_prepaid: boolean;
  status: 'pending' | 'approved' | 'rejected' | 'completed' | 'timeout';
  created_at: string;
  resolved_at: string | null;
  resolved_by: 'admin' | 'auto' | null;
}
```

---

## 🔄 תקשורת Realtime

### קליינט → אדמין:
1. קליינט יוצר רשומה ב-`punch_requests` עם `status='pending'`
2. אדמין מאזין ומקבל את הבקשה

### אדמין → קליינט:
1. אדמין מעדכן `status` ל-`approved`/`rejected`/`completed`
2. קליינט מאזין לשינויים ומגיב בהתאם

---

## ⚠️ נקודות חשובות

1. **Timeout:** אם אדמין לא מגיב תוך 60 שניות, הקליינט מציג הודעת timeout
2. **Prepaid:** לא צריך אישור אדמין - ניקוב אוטומטי
3. **לא Prepaid:** חייב אישור אדמין לפני ניקוב
4. **לוגים:** כל ניקוב נשמר בלוג לקוח למשך שנה
5. **ברקוד:** אותו פלואו בדיוק - תכנן קוד reusable

---

## 📁 קבצים רלוונטיים

- `docs/SUPABASE_NFC_SCHEMA.sql` - סקריפט יצירת טבלאות
- `docs/NFC_FEATURE_LOG.md` - לוג פיתוח הקליינט

---

## ✅ TODO לאדמין

1. [ ] הרץ SQL Schema
2. [ ] הוסף שדות NFC בהגדרות עסק
3. [ ] ממש האזנה Realtime לבקשות
4. [ ] ממש מודאל אישור ניקוב
5. [ ] ממש ביצוע ניקוב + עדכון DB
6. [ ] ממש שליחת Push ללקוח
7. [ ] ממש לוגים (נשמרים שנה)
8. [ ] בדיקות מול הקליינט

