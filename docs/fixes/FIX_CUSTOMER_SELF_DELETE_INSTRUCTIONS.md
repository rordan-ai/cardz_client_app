# הוראות תיקון מחיקה עצמאית של לקוח

## סטטוס: ✅ תיקונים הושלמו בקוד

## מה תוקן:

### 1. **תיקון הפונקציה `customer_self_delete` ב-Supabase**
   - **קובץ:** `sql/fix_customer_self_delete.sql`
   - **מה תוקן:** פתרון שגיאת "ambiguous business_code" על ידי נרמול קוד עסק (הסרת אפסים מובילים)
   - **פעולה נדרשת:** להריץ את הקובץ ב-Supabase SQL Editor

### 2. **הוספת RLS Policy למניעת הצגת לקוחות שנמחקו**
   - **קובץ:** `sql/add_customers_rls_soft_delete.sql`
   - **מה נוסף:** Policy שמסננת לקוחות עם `deleted_at IS NOT NULL` משאילתות SELECT
   - **פעולה נדרשת:** להריץ את הקובץ ב-Supabase SQL Editor

### 3. **הוספת בדיקת `deleted_at` בתהליך הכניסה**
   - **קובץ:** `app/(tabs)/PunchCard.tsx`
   - **מה נוסף:** 
     - בדיקה ב-query: `.is('deleted_at', null)`
     - בדיקה נוספת בקוד: `if (customers[0]?.deleted_at)`
   - **פעולה נדרשת:** הקוד כבר מתוקן, רק צריך לפרוס

### 4. **תיקון הלקוח הקיים ללא שם**
   - **קובץ:** `sql/fix_existing_customer_without_name.sql`
   - **מה זה:** שאילתת בדיקה + הערות לתיקון ידני
   - **פעולה נדרשת:** להריץ את השאילתה, לבדוק את התוצאה, ולהחליט אם למחוק או לשחזר שם

---

## סדר ביצוע מומלץ:

### שלב 1: תיקון הפונקציה ב-Supabase
1. פתח Supabase SQL Editor
2. העתק והדבק את התוכן מ-`sql/fix_customer_self_delete.sql`
3. הרץ את השאילתה
4. ודא שהפונקציה נוצרה בהצלחה

### שלב 2: הוספת RLS Policy
1. ב-Supabase SQL Editor
2. העתק והדבק את התוכן מ-`sql/add_customers_rls_soft_delete.sql`
3. הרץ את השאילתה
4. ודא שה-Policy נוצר בהצלחה

### שלב 3: בדיקת הלקוח הקיים
1. ב-Supabase SQL Editor
2. העתק והדבק את התוכן מ-`sql/fix_existing_customer_without_name.sql`
3. הרץ את השאילתה
4. בדוק את התוצאה:
   - אם `status = 'מצב לא תקין'` → להחליט אם למחוק או לשחזר שם
   - אם `status = 'נמחק כראוי'` → הכל תקין, לא צריך לעשות כלום
   - אם `status = 'פעיל תקין'` → הכל תקין

### שלב 4: בדיקת הפונקציה
```sql
-- בדיקה עם ערכים אמיתיים
select public.customer_self_delete('0002','0544515199');
-- אם success=true ו-updated>=1 → הפונקציה עובדת
```

### שלב 5: פריסת הקוד
- הקוד ב-`PunchCard.tsx` כבר מתוקן
- רק צריך לפרוס את האפליקציה

---

## בדיקות לאחר התיקון:

1. **בדיקת מחיקה עצמאית:**
   - להיכנס לאפליקציה כלקוח
   - ללחוץ על "מחיקת משתמש"
   - לאשר את המחיקה
   - לוודא שהמחיקה הצליחה והופיעה הודעת פרידה
   - לנסות להיכנס שוב עם אותו טלפון → צריך לקבל הודעה שהחשבון נמחק

2. **בדיקת כניסה של לקוח שנמחק:**
   - לנסות להיכנס עם טלפון של לקוח שנמחק
   - צריך לקבל הודעה: "החשבון נמחק ואינו פעיל יותר"

3. **בדיקת ממשק אדמין:**
   - לוודא שלקוחות שנמחקו לא מופיעים ברשימת הלקוחות
   - (אם יש RLS policy בממשק האדמין, צריך לוודא שהוא מסנן נכון)

---

## הערות חשובות:

- **לוגיקה עסקית:** לקוח יכול להיות בעל מספר כרטיסיות מוצר שונות באותו עסק - זה תקין ולא נפגע
- **תקופת המחיקה:** לקוח שנמחק (soft delete) ימחק סופית (hard delete) אחרי 30 ימים
- **שחזור:** אם צריך לשחזר לקוח שנמחק בטעות, צריך לעדכן ידנית: `UPDATE customers SET deleted_at = NULL, hard_delete_after = NULL WHERE ...`

---

## אם יש בעיות:

1. לבדוק את הלוגים ב-Supabase (Logs → Edge Functions או Database)
2. לבדוק את ה-RLS policies (Authentication → Policies)
3. לבדוק שהפונקציה קיימת (Database → Functions)

