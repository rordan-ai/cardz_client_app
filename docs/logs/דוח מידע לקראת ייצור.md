## דוח מידע לקראת ייצור

### תשתית Blacklist ל‑SMS – מפרט התחברות

- מטרת המנגנון: לאפשר Opt‑out מרכזי להודעות SMS (וגם Push), כך שנמענים שסימנו "הסר" לא יקבלו הודעות עוד לפני שליחה מהשרת/ספק צד שלישי.

#### סכימת נתונים (DB)
- טבלה מאוחדת: `notifications_blacklist`
  - `business_code` (text, not null)
  - `customer_phone` (text, not null) – מספר מנורמל (לדוגמה, IL: 05XXXXXXXX)
  - `channel` (text, not null, check in ('push','sms'))
  - `created_at` (timestamptz, default now())
  - Primary Key: (business_code, customer_phone, channel)
- אינדקסים:
  - `(business_code, channel)`
  - `(customer_phone)`

דוגמת יצירה: ראה `sql/notifications_blacklist.sql` בקוד.

#### סינון לפני שליחה (שרת)
- לפני שליחת SMS/Push יש לסנן נמענים עם רשומה מתאימה ב‑`notifications_blacklist`:
  - לשליחת SMS: `channel = 'sms'`
  - לשליחת Push: `channel = 'push'`

Pseudo‑SQL לדוגמה (SMS):
```sql
select c.customer_phone
from customers c
where c.business_code = :business_code
  and not exists (
    select 1
    from notifications_blacklist b
    where b.business_code = c.business_code
      and b.customer_phone = c.customer_phone
      and b.channel = 'sms'
  );
```

#### Webhook ל"הסר" (SMS מספק צד שלישי)
- Endpoint (דוגמה): `POST /webhooks/sms-unsubscribe`
- Auth: מומלץ HMAC חתום או API Key בכותרת `X-API-Key`.
- קלט (JSON):
```json
{
  "business_code": "1234",
  "phone": "+972544515199",
  "reason": "STOP",
  "provider": "third_party_name",
  "timestamp": "2025-11-16T12:34:56Z"
}
```
- עיבוד:
  - נרמול מספר טלפון ל־פורמט אחיד (IL: 05XXXXXXXX).
  - Insert ל‑`notifications_blacklist` עם `channel='sms'` (Idempotent):
```sql
insert into notifications_blacklist (business_code, customer_phone, channel)
values (:business_code, :normalized_phone, 'sms')
on conflict do nothing;
```
- פלט:
  - 200 OK: `{ "status": "ok" }`
  - 400/401/429/5xx לפי הצורך (כולל פרטי שגיאה לוגיים).

#### נרמול מספרים
- כלל בסיסי ל‑IL: שמירה כ‑`05XXXXXXXX` (10 ספרות).
- אם מגיע E.164 (למשל `+97254...`) – להמיר ל‑`05...`.

#### מדיניות יציבות ואבטחה
- Idempotency: `on conflict do nothing`/מזהה ייחודי לבקשה.
- Rate limiting ב‑Webhook (למשל 60 req/min לכל ספק).
- לוגים: אחסון סיבת ההסרה (`reason`, `provider`, `timestamp`) בטבלה ייעודית אופציונלית לצורך ביקורת.

#### נקודות אינטגרציה נוספות (אופציונלי)
- ממשק ניהול פנימי: הצגה/הסרה ידנית של רשומות Blacklist (עם הרשאות מתאימות).
- Export/Import: גיבוי ושחזור CSV מאובטח.

#### בדיקות קבלה (UAT)
- "הסר" מספק צד שלישי → מופיעה רשומה ב‑Blacklist (sms).
- שליחת SMS אחרי "הסר" → הנמען לא נבחר לשליחה.
- שינוי Opt‑in בצד לקוח → מופיעה/נמחקת רשומה ב‑Blacklist (לפי הצורך).
- Idempotency: שליחת "הסר" פעמיים לא יוצרת כפילויות/שגיאה.


