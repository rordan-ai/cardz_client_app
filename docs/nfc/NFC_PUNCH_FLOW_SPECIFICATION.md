# ğŸ“‹ NFC Punch Flow Specification
## ××¡××š ××¤×™×•×Ÿ ×œ×•×’×™×§×ª × ×™×§×•×‘×™ NFC

**×ª××¨×™×š:** 11/12/2025  
**×’×¨×¡×”:** 1.0  
**×¡×˜×˜×•×¡:** ×˜×™×•×˜×” ×œ××™×©×•×¨

---

## 1. ğŸ¯ ××˜×¨×ª ×”××¡××š

××¡××š ×–×” ××’×“×™×¨ ××ª ×”×œ×•×’×™×§×” ×”××œ××” ×œ× ×™×§×•×‘ ×‘×××¦×¢×•×ª NFC, ×›×•×œ×œ:
- ×—×œ×•×§×ª ××—×¨×™×•×ª ×‘×™×Ÿ ×”×§×œ×™×™× ×˜ ×œ××“××™×Ÿ
- ××¡× × ×•×ª (Filters) ×‘×›×œ ×¦×“
- ×¢×¨×•×¦×™ ×ª×§×©×•×¨×ª ×•×©×“×•×ª × ×“×¨×©×™×
- ××§×•×¨×•×ª × ×ª×•× ×™× ×•×”×–×¨×§×ª ××™×“×¢

---

## 2. ğŸ“Š ××¨×›×™×˜×§×˜×•×¨×” ×›×œ×œ×™×ª

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT (Mobile App)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ×¡×¨×™×§×ª NFC (Background/Foreground)                                       â”‚
â”‚  2. ×–×™×”×•×™ ×¢×¡×§ ×œ×¤×™ nfc_string                                                â”‚
â”‚  3. ×”×¤×¢×œ×ª ××¡× × ×•×ª ××§×•××™×•×ª (Local Filters)                                    â”‚
â”‚  4. ×©×™×“×•×¨ ×œ××“××™×Ÿ ×“×¨×š punch_requests                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼ Supabase Realtime
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ADMIN (Web Dashboard)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ×”××–× ×” ×œ-punch_requests (Realtime)                                       â”‚
â”‚  2. ×”×¤×¢×œ×ª ×œ×•×’×™×§×” ×–×”×” ×œ×‘×¨×§×•×“ (sounds, dialogs, notifications)                â”‚
â”‚  3. ×‘×™×¦×•×¢ ×”× ×™×§×•×‘ ×‘×¤×•×¢×œ                                                       â”‚
â”‚  4. ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×•×©×œ×™×—×ª ××™×©×•×¨                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ” ××¡× × ×•×ª ×¦×“ ×§×œ×™×™× ×˜ (Client-Side Filters)

×”×§×œ×™×™× ×˜ ××—×¨××™ ×¢×œ ×”××¡× × ×•×ª ×”×‘××•×ª **×œ×¤× ×™** ×©×œ×™×—×” ×œ××“××™×Ÿ:

| # | ××¡× × ×ª | ×ª× ××™ | ×¤×¢×•×œ×” | ×”×•×“×¢×” |
|---|-------|------|-------|-------|
| F1 | **× ×™×§×•×‘ ×™×“× ×™** | `punch_mode === 'manual'` | ×—×¡×•× | ×”×•×“×¢×” ×‘× ×•×¡×— ×©×¡×•×¤×§ ×¢"×™ ×”××¤×ª×— |
| F2 | **×ª×’ NFC ×œ× ××–×•×”×”** | `nfc_string` ×œ× × ××¦× | ×—×¡×•× | "×ª×’ NFC ×œ× ××–×•×”×”" |
| F3 | **×œ×§×•×— ×œ× ×©×™×™×š ×œ×¢×¡×§** | ××™×Ÿ ×›×¨×˜×™×¡×™×•×ª ×œ×¢×¡×§ ×–×” | ×—×¡×•× | "××™×Ÿ ×œ×š ×›×¨×˜×™×¡×™×™×” ×¤×¢×™×œ×” ×‘×¢×¡×§ ×–×”" |
| F4 | **×‘×—×™×¨×ª ×›×¨×˜×™×¡×™×™×”** | >1 ×›×¨×˜×™×¡×™×•×ª ×¤×¢×™×œ×•×ª | ×”×©×”×” | ×”×¦×’ ××¡×š ×‘×—×™×¨×”, ×”××©×š ××—×¨×™ ×‘×—×™×¨×” |
| F5 | **×”×’×¢×” ×œ××§×¡×™××•×** | `used_punches >= total_punches` | ×”×•×“×¢ ×œ××“××™×Ÿ | ×”×•×“×¢×” + ×©×™×“×•×¨ ×œ××“××™×Ÿ |
| F6 | **××™×Ÿ ×›×¨×˜×™×¡×™×™×” ×¤×¢×™×œ×”** | 0 ×›×¨×˜×™×¡×™×•×ª | ×—×¡×•× | "××™×Ÿ ×›×¨×˜×™×¡×™×™×” ×¤×¢×™×œ×”" |

### 3.1 ×¡×“×¨ ×”×¤×¢×œ×ª ×”××¡× × ×•×ª:

```
×¡×¨×™×§×ª NFC
    â”‚
    â–¼
[F2] ×ª×’ ××–×•×”×”? â”€â”€â”€ ×œ× â”€â”€â–º ×”×•×“×¢×ª ×©×’×™××”, ×¢×¦×•×¨
    â”‚ ×›×Ÿ
    â–¼
[F1] punch_mode === 'manual'? â”€â”€â”€ ×›×Ÿ â”€â”€â–º ×”×•×“×¢×ª ×—×¡×™××”, ×¢×¦×•×¨
    â”‚ ×œ×
    â–¼
[F6] ×™×© ×›×¨×˜×™×¡×™×•×ª ×¤×¢×™×œ×•×ª? â”€â”€â”€ ×œ× â”€â”€â–º ×”×•×“×¢×ª ×©×’×™××”, ×¢×¦×•×¨
    â”‚ ×›×Ÿ
    â–¼
[F3] ×›×¨×˜×™×¡×™×•×ª ×©×™×™×›×•×ª ×œ×¢×¡×§? â”€â”€â”€ ×œ× â”€â”€â–º ×”×•×“×¢×ª ×©×’×™××”, ×¢×¦×•×¨
    â”‚ ×›×Ÿ
    â–¼
[F4] ×›××” ×›×¨×˜×™×¡×™×•×ª? â”€â”€â”€ >1 â”€â”€â–º ×”×¦×’ ××¡×š ×‘×—×™×¨×”
    â”‚ 1                        â”‚
    â–¼                          â–¼ (×œ××—×¨ ×‘×—×™×¨×”)
[F5] ×”×’×¢×” ×œ××§×¡×™××•×? â”€â”€â”€ ×›×Ÿ â”€â”€â–º ×”×•×“×¢ ×œ××“××™×Ÿ + ×©×“×¨
    â”‚ ×œ×
    â–¼
×©×™×“×•×¨ ×œ××“××™×Ÿ (punch_requests)
```

---

## 4. ğŸ” ×œ×•×’×™×§×ª ×¦×“ ××“××™×Ÿ (Admin-Side Logic)

×”××“××™×Ÿ ××§×‘×œ ××ª ×›×œ ×”× ×™×§×•×‘×™× ×©×¢×‘×¨×• ××ª ×”××¡× × ×•×ª ×©×œ ×”×§×œ×™×™× ×˜ ×•××‘×¦×¢:

| # | ×¤×¢×•×œ×” | ×ª× ××™ | ×ª×•×¦××” |
|---|-------|------|-------|
| A1 | **×‘×“×™×§×ª ××¦×‘** | `punch_mode` | ×™×“× ×™: ×”×•×“×¢×”, ×—×¦×™-××•×˜×•: ××•×“××œ, ××•×˜×•: ×‘×™×¦×•×¢ |
| A2 | **×‘×“×™×§×ª ×›×¨×˜×™×¡×™×™×” ××œ××”** | `used_punches >= total_punches` | ×“×™××œ×•×’ ×—×™×“×•×© |
| A3 | **×‘×™×¦×•×¢ × ×™×§×•×‘** | - | ×¢×“×›×•×Ÿ `PunchCards`, ×œ×•×’, ×¦×œ×™×œ |
| A4 | **×‘×“×™×§×ª × ×™×§×•×‘ ××–×›×”** | `new_punches >= total_punches` | ×“×™××œ×•×’ ×”×˜×‘×” |
| A5 | **×©×œ×™×—×ª ×”×•×“×¢×” ×œ×œ×§×•×—** | - | Push notification |
| A6 | **×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡** | - | `punch_requests.status = 'completed'` |

### 4.1 ×–×¨×™××ª ×œ×•×’×™×§×” ×‘××“××™×Ÿ (×–×”×” ×œ×‘×¨×§×•×“):

```
×§×‘×œ×ª punch_request ×-Realtime
    â”‚
    â–¼
[A1] ×‘×“×™×§×ª punch_mode:
    â”œâ”€â”€ manual â”€â”€â–º ×”×•×“×¢×ª ×—×¡×™××” (×œ× ×××•×¨ ×œ×”×’×™×¢ ×›××Ÿ!)
    â”œâ”€â”€ semi â”€â”€â–º ×¤×ª×™×—×ª ××•×“××œ × ×™×§×•×‘
    â””â”€â”€ auto â”€â”€â–º ×”××©×š ×œ×‘×™×¦×•×¢
    â”‚
    â–¼
[A2] ×›×¨×˜×™×¡×™×™×” ××œ××”? â”€â”€â”€ ×›×Ÿ â”€â”€â–º ×“×™××œ×•×’ "×—×“×© ×•×‘×¦×¢ × ×™×§×•×‘"
    â”‚ ×œ×
    â–¼
[A3] ×‘×™×¦×•×¢ × ×™×§×•×‘:
    â”œâ”€â”€ ×¢×“×›×•×Ÿ PunchCards.used_punches
    â”œâ”€â”€ ×”×•×¡×¤×” ×œ-activity_logs
    â”œâ”€â”€ ×”×©××¢×ª ×¦×œ×™×œ ×”×¦×œ×—×”
    â””â”€â”€ ×¢×“×›×•×Ÿ state ××§×•××™
    â”‚
    â–¼
[A4] ×”×’×™×¢ ×œ× ×™×§×•×‘ ××–×›×”? â”€â”€â”€ ×›×Ÿ â”€â”€â–º ×“×™××œ×•×’ "×”×’×™×¢ ×œ×”×˜×‘×”"
    â”‚ ×œ×
    â–¼
[A5] ×©×œ×™×—×ª ×”×•×“×¢×” ×œ×œ×§×•×— (Push)
    â”‚
    â–¼
[A6] ×¢×“×›×•×Ÿ punch_requests.status = 'completed'
```

---

## 5. ğŸ“¡ ×¢×¨×•×¥ ×”×ª×§×©×•×¨×ª: ×˜×‘×œ×ª `punch_requests`

### 5.1 ××‘× ×” ×”×˜×‘×œ×”:

| ×©×“×” | ×¡×•×’ | ××§×•×¨ | ×ª×™××•×¨ |
|-----|-----|------|-------|
| `id` | uuid | ××•×˜×•××˜×™ | ××–×”×” ×™×™×—×•×“×™ |
| `business_code` | varchar | ×§×œ×™×™× ×˜ | ×§×•×“ ×”×¢×¡×§ (×-nfc_string) |
| `customer_phone` | varchar | ×§×œ×™×™× ×˜ | ×˜×œ×¤×•×Ÿ ×”×œ×§×•×— ×”××—×•×‘×¨ |
| `card_number` | varchar | ×§×œ×™×™× ×˜ | ××¡×¤×¨ ×”×›×¨×˜×™×¡×™×™×” (×œ××©×œ: "0002-0544515199-1234") |
| `product_name` | varchar | ×§×œ×™×™× ×˜ | ×©× ×”××•×¦×¨ |
| `is_prepaid` | boolean | ×§×œ×™×™× ×˜ | ×”×× ××©×•×œ× ××¨××© |
| `status` | varchar | ×§×œ×™×™× ×˜â†’××“××™×Ÿ | pendingâ†’completed/rejected |
| `created_at` | timestamp | ×§×œ×™×™× ×˜ | ×–××Ÿ ×™×¦×™×¨×” |
| `resolved_at` | timestamp | ××“××™×Ÿ | ×–××Ÿ ×˜×™×¤×•×œ |
| `resolved_by` | varchar | ××“××™×Ÿ | admin/auto |

### 5.2 ×”×¢×¨×” - ×©×“×•×ª ×§×™×™××™×:

**×œ× × ×“×¨×© ×©×“×” × ×•×¡×£!** ×›×œ ×”××™×“×¢ ×”× ×“×¨×© ×›×‘×¨ ×§×™×™×:

| ××™×“×¢ | ××§×•×¨ | ×˜×‘×œ×” |
|------|------|------|
| × ×™×§×•×‘×™× × ×•×›×—×™×™× | `used_punches` | `PunchCards` |
| ×¡×”"×› × ×™×§×•×‘×™× | `total_punches` | `PunchCards` |
| ×”×× ×”×’×™×¢ ×œ××§×¡×™××•× | ××—×•×©×‘: `used_punches >= total_punches` | - |
| ××§×•×¨ ×”× ×™×§×•×‘ | `source` | `activity_logs` |

---

## 6. ğŸ“¥ ××§×•×¨×•×ª × ×ª×•× ×™× (Data Sources)

### 6.1 × ×ª×•× ×™× ×©×”×§×œ×™×™× ×˜ ×©×•××‘:

| × ×ª×•×Ÿ | ×˜×‘×œ×” | ×©×“×” | ×©××™×œ×ª×” |
|------|------|-----|--------|
| ×§×•×“ ×¢×¡×§ | `businesses` | `business_code` | `WHERE nfc_string = ?` |
| ××¦×‘ × ×™×§×•×‘ | `businesses` | `punch_mode` | `WHERE nfc_string = ?` |
| ×›×¨×˜×™×¡×™×•×ª ×œ×§×•×— | `PunchCards` | * | `WHERE customer_phone = ? AND business_code = ? AND status = 'active'` |
| ×¤×¨×˜×™ ××•×¦×¨ | `products` | `product_name` | `WHERE product_code = ?` |

### 6.2 × ×ª×•× ×™× ×©×”××“××™×Ÿ ×©×•××‘:

| × ×ª×•×Ÿ | ×˜×‘×œ×” | ×©×“×” | ×©××™×œ×ª×” |
|------|------|-----|--------|
| ×¤×¨×˜×™ ×œ×§×•×— | `customers` | `name` | `WHERE customer_phone = ?` |
| ×¤×¨×˜×™ ×¢×¡×§ | `businesses` | `name, punch_mode` | `WHERE business_code = ?` |
| ×”×˜×‘×” | `PunchCards` | `benefit` | `WHERE card_number = ?` |

---

## 7. ğŸ”„ ×–×¨×™××ª ××™×“×¢ ××œ××” (End-to-End Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PHASE 1: ×¡×¨×™×§×” ×•×–×™×”×•×™                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CLIENT:                                                                    â”‚
â”‚  1. ×¡×¨×™×§×ª ×ª×’ NFC â†’ ×§×‘×œ×ª nfc_string                                         â”‚
â”‚  2. ×©××™×œ×ª×”: SELECT business_code, name, punch_mode                         â”‚
â”‚             FROM businesses WHERE nfc_string = '{value}'                   â”‚
â”‚  3. ×× ×œ× × ××¦× â†’ ×”×•×“×¢×ª ×©×’×™××”, ×¢×¦×•×¨                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PHASE 2: ××¡× × ×•×ª ×§×œ×™×™× ×˜                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CLIENT:                                                                    â”‚
â”‚  1. ×× punch_mode === 'manual' â†’ ×”×•×“×¢×ª ×—×¡×™××”, ×¢×¦×•×¨                         â”‚
â”‚  2. ×©××™×œ×ª×”: SELECT * FROM "PunchCards"                                     â”‚
â”‚             WHERE customer_phone = '{phone}'                               â”‚
â”‚             AND business_code = '{code}' AND status = 'active'             â”‚
â”‚  3. ×× 0 ×›×¨×˜×™×¡×™×•×ª â†’ ×”×•×“×¢×ª ×©×’×™××”, ×¢×¦×•×¨                                      â”‚
â”‚  4. ×× >1 ×›×¨×˜×™×¡×™×•×ª â†’ ×”×¦×’ ××¡×š ×‘×—×™×¨×”                                         â”‚
â”‚  5. ×‘×“×•×§ ×× used_punches >= total_punches â†’ ×¡××Ÿ is_at_max = true           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PHASE 3: ×©×™×“×•×¨ ×œ××“××™×Ÿ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CLIENT:                                                                    â”‚
â”‚  INSERT INTO punch_requests (                                               â”‚
â”‚    business_code, customer_phone, card_number, product_name,               â”‚
â”‚    is_prepaid, status, created_at                                          â”‚
â”‚  ) VALUES (                                                                 â”‚
â”‚    '{business_code}', '{phone}', '{card_number}', '{product_name}',        â”‚
â”‚    {is_prepaid}, 'pending', NOW()                                          â”‚
â”‚  );                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ Supabase Realtime
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PHASE 4: ×˜×™×¤×•×œ ××“××™×Ÿ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ADMIN:                                                                     â”‚
â”‚  1. ×§×‘×œ×ª ×”×‘×§×©×” ×“×¨×š Realtime subscription                                   â”‚
â”‚  2. ×‘×“×™×§×ª punch_mode (×™×“× ×™/×—×¦×™/××•×˜×•)                                       â”‚
â”‚  3. ×‘×“×™×§×ª ×›×¨×˜×™×¡×™×™×” ××œ××” â†’ ×“×™××œ×•×’ ×—×™×“×•×©                                     â”‚
â”‚  4. ×‘×™×¦×•×¢ × ×™×§×•×‘: UPDATE "PunchCards" SET used_punches = used_punches + 1   â”‚
â”‚  5. ×œ×•×’: INSERT INTO activity_logs (...)                                   â”‚
â”‚  6. ×¦×œ×™×œ ×”×¦×œ×—×”                                                              â”‚
â”‚  7. ×‘×“×™×§×ª × ×™×§×•×‘ ××–×›×” â†’ ×“×™××œ×•×’ ×”×˜×‘×”                                         â”‚
â”‚  8. ×©×œ×™×—×ª Push ×œ×œ×§×•×—                                                        â”‚
â”‚  9. UPDATE punch_requests SET status = 'completed'                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ Supabase Realtime
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PHASE 5: ××™×©×•×¨ ×œ×œ×§×•×—                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CLIENT:                                                                    â”‚
â”‚  1. ×”××–× ×” ×œ×¢×“×›×•×Ÿ status ×‘-punch_requests                                   â”‚
â”‚  2. ×× status === 'completed' â†’ ×”×¦×’ ××™×©×•×¨ × ×™×§×•×‘, ×¢×“×›×Ÿ UI                   â”‚
â”‚  3. ×× status === 'rejected' â†’ ×”×¦×’ ×”×•×“×¢×ª ×©×’×™××”                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ğŸ“‹ ×©××™×œ×ª×•×ª SQL ××¨×›×–×™×•×ª

### 8.1 ×§×œ×™×™× ×˜ - ×–×™×”×•×™ ×¢×¡×§:
```sql
SELECT business_code, name, punch_mode 
FROM businesses 
WHERE nfc_string = '{scanned_nfc_string}';
```

### 8.2 ×§×œ×™×™× ×˜ - ×©×œ×™×¤×ª ×›×¨×˜×™×¡×™×•×ª:
```sql
SELECT 
  card_number, 
  product_code, 
  used_punches, 
  total_punches, 
  prepaid, 
  benefit, 
  status
FROM "PunchCards"
WHERE customer_phone = '{phone}'
  AND business_code = '{business_code}'
  AND status = 'active';
```

### 8.3 ×§×œ×™×™× ×˜ - ×©×™×“×•×¨ × ×™×§×•×‘:
```sql
INSERT INTO punch_requests (
  business_code, 
  customer_phone, 
  card_number, 
  product_name, 
  is_prepaid, 
  status, 
  created_at
) VALUES (
  '{business_code}',
  '{customer_phone}',
  '{card_number}',
  '{product_name}',
  {is_prepaid},
  'pending',
  NOW()
);
```

### 8.4 ××“××™×Ÿ - ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡:
```sql
UPDATE punch_requests 
SET status = 'completed',
    resolved_at = NOW(),
    resolved_by = 'admin'
WHERE id = '{request_id}';
```

---

## 9. âœ… × ×§×•×“×•×ª ×©× ×‘×“×§×•

| # | ×‘×“×™×§×” | ×¡×˜×˜×•×¡ |
|---|-------|-------|
| 1 | ×©×“×” `punch_context` | âŒ ×œ× × ×“×¨×© - ×”×©×“×•×ª ×§×™×™××™× ×‘×˜×‘×œ××•×ª ××—×¨×•×ª |
| 2 | Realtime ×¢×œ `punch_requests` | âœ… ××•×¤×¢×œ |
| 3 | RLS - INSERT ××”×§×œ×™×™× ×˜ | âœ… "Anyone can create punch request" |
| 4 | RLS - SELECT/UPDATE ××”××“××™×Ÿ | âœ… ×××•×¤×©×¨ |
| 5 | ×©×“×” `card_number` | âœ… ×”×•×—×œ×£ ×-`card_id` (integer) ×œ-`card_number` (varchar) |
| 6 | ×’×™×‘×•×™ ××‘× ×” | âœ… × ×©××¨ ×‘-`punch_requests_backup_structure` |

---

## 10. ğŸ“ ×”×™×¡×˜×•×¨×™×™×ª ×’×¨×¡××•×ª

| ×’×¨×¡×” | ×ª××¨×™×š | ×©×™× ×•×™×™× |
|------|-------|---------|
| 1.0 | 11/12/2025 | ××¡××š ×¨××©×•× ×™ |
| 1.1 | 11/12/2025 | ×©×™× ×•×™ `card_id` ×œ-`card_number`, ×”×¡×¨×ª `punch_context` (×œ× × ×“×¨×©) |

---

**××¡××š ×–×” ××”×•×•×” ××ª ×—×•×˜ ×”×©×“×¨×” ×”××•×‘×™×œ ×œ×™×™×©×•× NFC Punch Flow.**

